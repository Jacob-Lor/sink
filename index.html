<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e1e9ff 0%, #9faddd 25%, #92b4ff 50%, #e3eeff 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .game-layout {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            gap: 24px;
            padding: 24px;
            min-height: 100vh;
        }

        .main-game {
            flex: 1;
            min-width: 0;
        }

        .sidebar {
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .sidebar h3 {
            color: #1f2937;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }

        .info-card h4 {
            color: #1e40af;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-card p {
            color: #64748b;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .tip-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .tip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.1);
        }

        .tip-card h4 {
            color: #92400e;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tip-card p {
            color: #a16207;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .progress-tracker {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .progress-tracker:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
        }

        .progress-tracker h4 {
            color: #1e40af;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-container {
            position: relative;
            margin-bottom: 8px;
        }

        .progress-background {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            height: 100%;
            width: 3.33%;
            transition: width 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.2) 0%, 
                rgba(255,255,255,0.4) 50%, 
                rgba(255,255,255,0.2) 100%);
            animation: shimmer 2s infinite;
        }

        .progress-marker {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            transform: translateX(-8px);
            transition: left 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            color: #1e40af;
            font-size: 0.85em;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .quick-stats {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .quick-stats:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.1);
        }

        .quick-stats h4 {
            color: #166534;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .stat-label {
            color: #166534;
            font-size: 0.85em;
            font-weight: 500;
        }

        .stat-value-small {
            color: #059669;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .container {
            width: 100%;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 32px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.02em;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 28px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            border-radius: 12px 12px 0 0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.12);
        }

        .stat-card h3 {
            color: #4b5563;
            margin-bottom: 12px;
            font-size: 0.95em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1f2937;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: all 0.3s ease;
        }

        .news-section {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 24px 28px;
            border-radius: 12px;
            margin-bottom: 32px;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .news-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(5, 150, 105, 0.3);
        }

        .news-section h3 {
            margin-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-section p {
            font-size: 1.05em;
            line-height: 1.5;
            font-weight: 400;
        }

        .debt-section, .investment-section {
            background: white;
            padding: 36px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .debt-section:hover, .investment-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .debt-section h2, .investment-section h2 {
            color: #1f2937;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .debt-section h2 {
            color: #dc2626;
            border-bottom-color: #fecaca;
        }

        .debt-options, .investment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .investment-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            background: #fafafa;
            position: relative;
            overflow: hidden;
        }

        .investment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .investment-card:hover::before {
            opacity: 1;
        }

        .investment-card:hover {
            border-color: #3b82f6;
            transform: translateY(-6px);
            box-shadow: 0 16px 40px rgba(59, 130, 246, 0.15);
            background: white;
        }

        .investment-card.debt-card {
            border: 2px solid #fca5a5;
            background: #fef2f2;
        }

        .investment-card.debt-card::before {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .investment-card.debt-card:hover {
            border-color: #dc2626;
            box-shadow: 0 16px 40px rgba(220, 38, 38, 0.15);
            background: #fefefe;
        }

        .investment-card h4 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 1.25em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debt-card h4 {
            color: #dc2626;
        }

        .investment-card p {
            margin-bottom: 20px;
            color: #6b7280;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .debt-card .price-info {
            background: rgba(220, 38, 38, 0.05);
            border-color: rgba(220, 38, 38, 0.1);
        }

        .current-price {
            font-weight: 700;
            color: #1f2937;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 1.1em;
        }

        .price-change {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: all 0.3s ease;
        }

        .price-up {
            color: #059669;
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }

        .price-down {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        .investment-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .amount-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            background: white;
        }

        .amount-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: scale(1.01);
        }

        .invest-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            min-width: 120px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invest-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
        }

        .invest-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .debt-btn {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .debt-btn:hover {
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
            background: linear-gradient(135deg, #b91c1c, #dc2626);
        }

        .portfolio-section {
            background: white;
            padding: 36px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .portfolio-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .portfolio-section h2 {
            color: #1f2937;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .portfolio-item:hover {
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.02), transparent);
            padding-left: 12px;
            padding-right: 12px;
            border-radius: 8px;
            transform: translateX(4px);
        }

        .portfolio-item:last-child {
            border-bottom: none;
        }

        .portfolio-item strong {
            font-weight: 600;
            color: #1f2937;
        }

        .portfolio-item small {
            color: #6b7280;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .debt-item {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.02), rgba(220, 38, 38, 0.05), rgba(220, 38, 38, 0.02));
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 8px 0;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .debt-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }

        .controls {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .next-period-btn {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
        }

        .next-period-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.3);
            background: linear-gradient(135deg, #047857, #059669);
        }

        .reset-btn {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
        }

        .reset-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 32px rgba(107, 114, 128, 0.3);
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }

        .game-over {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 48px 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 64px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .game-over:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 64px rgba(0,0,0,0.3);
        }

        .game-over h2 {
            font-size: 2.8em;
            margin-bottom: 24px;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .final-score {
            font-size: 3.5em;
            font-weight: 800;
            margin: 24px 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            letter-spacing: -0.02em;
            transition: all 0.3s ease;
        }

        .game-over p {
            font-size: 1.2em;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        /* Professional banking-style enhancements */
        .stat-card:nth-child(1) .stat-value { color: #059669; }
        .stat-card:nth-child(2) .stat-value { color: #3b82f6; }
        .stat-card:nth-child(3) .stat-value { color: #7c3aed; }
        .stat-card:nth-child(4) .stat-value { color: #f59e0b; }

        /* Restructuring Section Styles */
        .restructuring-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .restructuring-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .restructuring-section h3 {
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .restructuring-option {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .restructuring-option:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }

        .restructuring-option h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1e40af;
        }

        .restructuring-option p {
            margin-bottom: 8px;
            color: #64748b;
        }

        .restructuring-option .rate-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .restructuring-option .fee-badge {
            display: inline-block;
            background: #ecfdf5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .restructuring-controls {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .debt-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            cursor: pointer;
        }

        .debt-checkbox:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .debt-checkbox input {
            margin-right: 12px;
        }

        .debt-checkbox-label {
            flex: 1;
        }

        .debt-checkbox-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .debt-checkbox-details {
            font-size: 0.85em;
            color: #64748b;
        }

        .execute-restructuring-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            margin-right: 8px;
        }

        .execute-restructuring-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(30, 64, 175, 0.2);
        }

        .cancel-restructuring-btn {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .cancel-restructuring-btn:hover {
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        /* Credit Score Section */
        .credit-score-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .credit-score-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }

        .credit-score-value {
            font-size: 2.5em;
            font-weight: 700;
            margin: 8px 0;
            transition: all 0.3s ease;
        }

        .credit-score-range {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .credit-score-factors {
            margin-top: 12px;
        }

        .credit-score-factor {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85em;
        }

        .credit-score-factor-label {
            color: #64748b;
        }

        .credit-score-factor-value {
            font-weight: 600;
            color: #1e40af;
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .game-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .game-layout {
                padding: 16px;
                gap: 16px;
            }
            
            .sidebar {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .debt-options, .investment-options {
                grid-template-columns: 1fr;
            }
            
            .investment-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .amount-input {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .next-period-btn, .reset-btn {
                width: 100%;
                max-width: 280px;
            }
            
            .debt-section, .investment-section, .portfolio-section {
                padding: 24px 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 24px 16px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .final-score {
                font-size: 2.5em;
            }
            
            .game-over {
                padding: 32px 24px;
            }
        }

        /* Game Over Popup Styles */
        .game-over-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .game-over-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .game-over-content {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.7) translateY(50px);
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
            border: 2px solid transparent;
        }

        .game-over-popup.show .game-over-content {
            transform: scale(1) translateY(0);
        }

        .game-over-content.success {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
        }

        .game-over-content.failure {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #fef2f2);
        }

        .game-over-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        .game-over-title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .game-over-subtitle {
            font-size: 1.2em;
            color: #6b7280;
            margin-bottom: 25px;
        }

        .game-over-stats {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
        }

        .game-over-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .game-over-stat:last-child {
            margin-bottom: 0;
            font-weight: 700;
            font-size: 1.3em;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .game-over-stat-label {
            color: #6b7280;
        }

        .game-over-stat-value {
            font-weight: 600;
            color: #1f2937;
        }

        .game-over-stat-value.positive {
            color: #10b981;
        }

        .game-over-stat-value.negative {
            color: #ef4444;
        }

        .game-over-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .game-over-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .game-over-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .game-over-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .game-over-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .game-over-btn.secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes confetti {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #fbbf24;
            animation: confetti 3s linear infinite;
            z-index: 999;
        }

        .confetti:nth-child(2n) {
            background: #10b981;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            background: #3b82f6;
            animation-delay: 1s;
        }

        .confetti:nth-child(4n) {
            background: #ef4444;
            animation-delay: 1.5s;
        }

        .confetti:nth-child(5n) {
            background: #8b5cf6;
            animation-delay: 2s;
        }

        /* Mobile responsiveness */
    </style>
</head>
<body>
    <div class="game-layout">
        <div class="main-game">
            <div class="container">
                <div class="header">
                    <h1>📈 Build Your Portfolio</h1>
                    <p>Make smart investment decisions over 30 months and watch your money grow!</p>
                </div>

                <div class="game-stats">
                    <div class="stat-card">
                        <h3>💰 Available Cash</h3>
                        <div class="stat-value" id="cash">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>📊 Investment Value</h3>
                        <div class="stat-value" id="portfolioValue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>💎 Total Worth</h3>
                        <div class="stat-value" id="totalWorth">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>📅 Month</h3>
                        <div class="stat-value" id="period">1 / 30</div>
                    </div>
                </div>

                <div class="news-section" id="newsSection">
                    <h3>📰 Market News</h3>
                    <p id="newsText">Welcome to the investment game! You start with $5,000. Make wise choices!</p>
                </div>

                <div class="debt-section" id="debtSection">
                    <h2>💳 Debt Options</h2>
                    <div class="debt-options" id="debtOptions">
                        <!-- Debt cards will be generated here -->
                    </div>
                </div>

                <div class="restructuring-section" id="restructuringSection">
                    <h3>🔄 Debt Restructuring Options</h3>
                    <p>Consolidate or refinance your debts for better terms based on your credit score</p>
                    <div id="restructuringOptions"></div>
                    <div id="restructuringControls" style="display: none;">
                        <h4>Select Debts to Restructure:</h4>
                        <div id="debtSelection"></div>
                        <div style="margin-top: 15px;">
                            <label for="restructuringType">Restructuring Type:</label>
                            <select id="restructuringType">
                                <option value="consolidation">Debt Consolidation</option>
                                <option value="refinancing">Refinancing</option>
                                <option value="balance_transfer">Balance Transfer</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="execute-restructuring-btn" id="executeRestructuringBtn">Execute Restructuring</button>
                            <button class="cancel-restructuring-btn">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="investment-section" id="investmentSection" style="display: none;">
                    <h2>💼 Investment Options</h2>
                    <div class="investment-options" id="investmentOptions">
                        <!-- Investment cards will be generated here -->
                    </div>
                </div>

                <div class="portfolio-section">
                    <h2>📋 Your Portfolio</h2>
                    <div id="portfolio">
                        <p style="text-align: center; color: #666; padding: 20px;">No investments yet. Start building your portfolio!</p>
                    </div>
                </div>

                <div class="controls">
                    <button class="next-period-btn" id="nextPeriodBtn">⏭️ Next Month</button>
                    <button class="reset-btn" id="resetBtn">🔄 Reset Game</button>
                </div>

                <div class="game-over" id="gameOver" style="display: none;">
                    <h2>🎉 Game Complete!</h2>
                    <div class="final-score" id="finalScore">$0</div>
                    <p>You've completed 30 months of investing!</p>
                    <button class="reset-btn" onclick="resetGame()" style="margin-top: 20px;">Play Again</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>🎯 Game Info</h3>
            
            <!-- Credit Score Section -->
            <div class="credit-score-card">
                <h4>📊 Credit Score</h4>
                <div class="credit-score-value" id="creditScore">580</div>
                <div class="credit-score-range" id="creditRange">Fair</div>
                <p id="creditDescription">Your credit is fair - keep improving!</p>
                <div class="credit-score-factors">
                    <div class="credit-score-factor">
                        <span class="credit-score-factor-label">Payment History:</span>
                        <span class="credit-score-factor-value" id="paymentHistory">0 payments</span>
                    </div>
                </div>
            </div>

            <!-- Month Progress Tracker -->
            <div class="progress-tracker">
                <h4>📅 Month Progress</h4>
                <div class="progress-container">
                    <div class="progress-background">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-marker" id="progressMarker"></div>
                </div>
                <div class="progress-text" id="progressText">Month 1 of 30</div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <h4>⚡ Quick Stats</h4>
                <div class="stat-row">
                    <span class="stat-label">Return Rate:</span>
                    <span class="stat-value-small" id="returnRate">0.0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Month:</span>
                    <span class="stat-value-small" id="bestMonth">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Worst Month:</span>
                    <span class="stat-value-small" id="worstMonth">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Risk Level:</span>
                    <span class="stat-value-small" id="riskLevel">Low</span>
                </div>
            </div>

            <!-- Strategy Tip -->
            <div class="tip-card">
                <h4>💡 Strategy Tip</h4>
                <p>Focus on paying off high-interest debts first, then diversify your investments between stocks and bonds for balanced growth.</p>
            </div>
        </div>
    </div>

    <div class="game-over-popup" id="gameOverPopup">
        <div class="game-over-content" id="gameOverContent">
            <div class="game-over-icon">🎉</div>
            <h2 class="game-over-title">Congratulations!</h2>
            <p class="game-over-subtitle">You've successfully completed the game!</p>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Final Score:</span>
                    <span class="game-over-stat-value" id="finalScore"></span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Credit Score:</span>
                    <span class="game-over-stat-value" id="finalCreditScore"></span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Credit Range:</span>
                    <span class="game-over-stat-value" id="finalCreditRange"></span>
                </div>
            </div>
            <p class="game-over-message">Your journey through the investment game has come to an end. You've made smart decisions and learned a lot along the way. Keep up the good work!</p>
            <div class="game-over-buttons">
                <button class="game-over-btn primary" onclick="resetGame()">Play Again</button>
                <button class="game-over-btn secondary" onclick="closeGameOverPopup()">Close</button>
            </div>
        </div>
    </div>

    <script>
// Credit Score System Class
        class CreditScoreSystem {
            constructor() {
                this.score = 580; // Starting with fair credit
                this.paymentHistory = [];
                this.accountAge = 12; // Start with 1 year credit history
                this.consecutiveOnTimePayments = 0;
                this.totalPaymentsMade = 0;
                this.latePayments = 0;
                this.totalDebtPaidOff = 0;
                this.initialTotalDebt = 0;
                this.creditUtilization = 0;
                this.scoreHistory = [580];
                
                // Calculate initial debt for utilization tracking
                this.calculateInitialDebt();
            }

            calculateInitialDebt() {
                this.initialTotalDebt = 8500 + 1200 + 15000 + 45000; // Sum of all initial debts
            }

            // Calculate current credit utilization ratio
            calculateCreditUtilization() {
                const currentTotalDebt = this.getCurrentTotalDebt();
                const creditCardDebt = gameState.investments.creditcard.price;
                const creditCardLimit = 10000; // Assume $10k credit limit
                
                if (creditCardLimit > 0) {
                    this.creditUtilization = (creditCardDebt / creditCardLimit) * 100;
                } else {
                    this.creditUtilization = 0;
                }
                
                return this.creditUtilization;
            }

            getCurrentTotalDebt() {
                let totalDebt = 0;
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        totalDebt += investment.price;
                    }
                });
                return totalDebt;
            }

            // Process a debt payment and update credit score
            processDebtPayment(debtType, paymentAmount, debtRemaining) {
                const payment = {
                    debtType: debtType,
                    amount: paymentAmount,
                    remainingDebt: debtRemaining,
                    date: gameState.period,
                    onTime: true // Assume all payments in game are on time
                };

                this.paymentHistory.push(payment);
                this.totalPaymentsMade++;
                this.consecutiveOnTimePayments++;
                this.totalDebtPaidOff += paymentAmount;

                // Calculate score change
                const oldScore = this.score;
                this.updateCreditScore(payment);
                const scoreChange = this.score - oldScore;

                // Add to score history
                this.scoreHistory.push(this.score);

                return {
                    oldScore: oldScore,
                    newScore: this.score,
                    scoreChange: scoreChange
                };
            }

            updateCreditScore(payment) {
                let scoreChange = 0;

                // 1. Payment History (35% of score) - Most important factor
                if (payment.onTime) {
                    // Base points for making payment
                    scoreChange += Math.min(3, payment.amount / 1000); // Up to 3 points per $1000 paid
                    
                    // Bonus for consecutive payments
                    if (this.consecutiveOnTimePayments >= 6) {
                        scoreChange += 2; // Bonus for payment consistency
                    }
                    
                    // Extra bonus for paying off high-interest debt
                    if (payment.debtType === 'payday' && payment.remainingDebt === 0) {
                        scoreChange += 15; // Big boost for paying off payday loans
                    } else if (payment.debtType === 'creditcard' && payment.remainingDebt === 0) {
                        scoreChange += 12; // Good boost for paying off credit cards
                    }
                }

                // 2. Credit Utilization (30% of score)
                const utilizationChange = this.calculateUtilizationScoreChange();
                scoreChange += utilizationChange;

                // 3. Length of Credit History (15% of score)
                this.accountAge++; // Age increases each period
                if (this.accountAge % 12 === 0) { // Every year
                    scoreChange += 1;
                }

                // 4. Types of Credit (10% of score)
                const debtTypesRemaining = this.getActiveDebtTypes();
                if (debtTypesRemaining.length < 4) { // Fewer debt types is better
                    scoreChange += 1;
                }

                // 5. New Credit (10% of score) - Not applicable in this game

                // Apply diminishing returns for very high scores
                if (this.score >= 750) {
                    scoreChange *= 0.5; // Harder to improve excellent credit
                } else if (this.score >= 700) {
                    scoreChange *= 0.7; // Somewhat harder to improve good credit
                }

                // Apply the change
                this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            }

            calculateUtilizationScoreChange() {
                const currentUtilization = this.calculateCreditUtilization();
                let scoreChange = 0;

                // Credit utilization brackets with score impacts
                if (currentUtilization === 0) {
                    scoreChange += 3; // Best utilization
                } else if (currentUtilization <= 10) {
                    scoreChange += 2; // Excellent utilization
                } else if (currentUtilization <= 30) {
                    scoreChange += 1; // Good utilization
                } else if (currentUtilization <= 50) {
                    scoreChange += 0; // Fair utilization
                } else if (currentUtilization <= 75) {
                    scoreChange -= 1; // Poor utilization
                } else {
                    scoreChange -= 2; // Very poor utilization
                }

                return scoreChange;
            }

            getActiveDebtTypes() {
                const activeDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        activeDebts.push(key);
                    }
                });
                return activeDebts;
            }

            getCreditScoreRange() {
                if (this.score >= 800) return { range: "Excellent", color: "#10b981", description: "You have exceptional credit!" };
                if (this.score >= 740) return { range: "Very Good", color: "#059669", description: "You have very good credit!" };
                if (this.score >= 670) return { range: "Good", color: "#3b82f6", description: "You have good credit!" };
                if (this.score >= 580) return { range: "Fair", color: "#f59e0b", description: "Your credit is fair - keep improving!" };
                return { range: "Poor", color: "#ef4444", description: "Your credit needs work - focus on debt payments!" };
            }

            // Age credit history each period
            ageAccount() {
                this.accountAge++;
                
                // Small score boost for account aging (every 6 months)
                if (this.accountAge % 6 === 0 && this.score < 800) {
                    this.score = Math.min(850, this.score + 1);
                    this.scoreHistory.push(this.score);
                }
            }

            getScoreFactors() {
                const utilization = this.calculateCreditUtilization();
                const activeDebts = this.getActiveDebtTypes().length;
                
                return {
                    paymentHistory: `${this.consecutiveOnTimePayments} consecutive on-time payments`,
                    creditUtilization: `${utilization.toFixed(1)}% utilization`,
                    creditHistory: `${Math.floor(this.accountAge / 12)} years, ${this.accountAge % 12} months`,
                    creditMix: `${activeDebts} active debt accounts`,
                    totalPaid: `$${this.totalDebtPaidOff.toLocaleString()} total debt paid off`
                };
            }
        }

        // Initialize credit score system
        let creditScoreSystem = new CreditScoreSystem();

        // Game state (existing code with credit score integration)
        let gameState = {
            cash: 5000,
            period: 1,
            maxPeriods: 30,
            portfolio: {},
            investments: {
                stocks: { 
                    name: 'Stock Market Index', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Diversified stock market fund with moderate risk and good long-term returns',
                    volatility: 0.15 
                },
                bonds: { 
                    name: 'Government Bonds', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Safe government bonds with steady, low returns',
                    volatility: 0.05 
                },
                creditcard: { 
                    name: 'Credit Card Debt', 
                    price: 8500, 
                    basePrice: 8500,
                    description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.015
                },
                payday: { 
                    name: 'Payday Loan Debt', 
                    price: 1200, 
                    basePrice: 1200,
                    description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.333
                },
                autoloan: { 
                    name: 'Auto Loan Debt', 
                    price: 15000, 
                    basePrice: 15000,
                    description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.005
                },
                mortgage: { 
                    name: 'Mortgage Debt', 
                    price: 45000, 
                    basePrice: 45000,
                    description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.0033
                }
            },
            priceHistory: {},
            newsEvents: [
                "Market showing steady growth across all sectors.",
                "Economic indicators suggest continued expansion.",
                "Tech sector experiencing significant growth this month.",
                "Interest rates remain stable, benefiting bond markets.",
                "Financial advisors recommend paying off high-interest debt first.",
                "Credit card interest rates continue to climb nationwide.",
                "Auto loan rates see slight increase due to Federal Reserve policy.",
                "Mortgage rates remain competitive for qualified borrowers.",
                "Consumer debt reaches new highs - experts advise caution.",
                "Payday loan regulations tighten in several states.",
                "Real estate market shows strong fundamentals.",
                "Global markets react to positive economic data.",
                "Debt consolidation services see increased demand.",
                "Financial literacy programs emphasize debt management.",
                "Good credit scores unlock better loan terms and rates.",
                "Credit utilization below 30% is recommended by experts.",
                "Payment history is the most important factor in credit scoring.",
                "Paying off debt early can significantly boost your credit score."
            ]
        };

        // Initialize price history
        Object.keys(gameState.investments).forEach(key => {
            gameState.priceHistory[key] = [gameState.investments[key].price];
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updatePrices() {
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) {
                    // Debt grows with monthly interest
                    investment.price = Math.round(investment.price * (1 + investment.monthlyInterestRate));
                } else {
                    // Regular investments fluctuate with market volatility
                    const change = (Math.random() - 0.5) * 2 * investment.volatility;
                    const newPrice = Math.max(investment.price * (1 + change), 10);
                    investment.price = Math.round(newPrice);
                }
                gameState.priceHistory[key].push(investment.price);
            });
        }

        function calculatePortfolioValue() {
            let totalValue = 0;
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    totalValue += gameState.portfolio[key] * gameState.investments[key].price;
                }
            });
            return totalValue;
        }

        function calculateTotalDebt() {
            let totalDebt = 0;
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    totalDebt += investment.price;
                }
            });
            return totalDebt;
        }

        function updateDisplay() {
            document.getElementById('cash').textContent = formatCurrency(gameState.cash);
            document.getElementById('period').textContent = `${gameState.period} / ${gameState.maxPeriods}`;
            
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const netWorth = gameState.cash + portfolioValue - totalDebt;
            
            document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalWorth').textContent = formatCurrency(netWorth);

            // Update progress tracker
            const progressPercentage = (gameState.period / gameState.maxPeriods) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            document.getElementById('progressMarker').style.left = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `Month ${gameState.period} of ${gameState.maxPeriods}`;

            // Update credit score display
            updateCreditScoreDisplay();

            // Show/hide investment options based on round
            const investmentSection = document.getElementById('investmentSection');
            if (gameState.period >= 5) {
                investmentSection.style.display = 'block';
                updateInvestmentOptions();
            } else {
                investmentSection.style.display = 'none';
            }

            // Update debt options
            updateDebtOptions();
            updatePortfolioDisplay();
            
            // Update restructuring options
            updateRestructuringDisplay();
        }

        function updateCreditScoreDisplay() {
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            const creditScoreElement = document.getElementById('creditScore');
            const creditRangeElement = document.getElementById('creditRange');
            const creditDescElement = document.getElementById('creditDescription');
            
            if (creditScoreElement) {
                creditScoreElement.textContent = creditScoreSystem.score;
                creditScoreElement.style.color = creditInfo.color;
            }
            
            if (creditRangeElement) {
                creditRangeElement.textContent = creditInfo.range;
                creditRangeElement.style.color = creditInfo.color;
                creditRangeElement.style.backgroundColor = `${creditInfo.color}20`; // Add opacity
            }
            
            if (creditDescElement) {
                creditDescElement.textContent = creditInfo.description;
            }

            // Update payment history only
            document.getElementById('paymentHistory').textContent = 
                `${creditScoreSystem.consecutiveOnTimePayments} consecutive payments`;
        }

        function showCreditScoreChange(scoreChange) {
            if (scoreChange.scoreChange !== 0) {
                const changeText = scoreChange.scoreChange > 0 ? 
                    `+${scoreChange.scoreChange}` : `${scoreChange.scoreChange}`;
                
                alert(`Credit Score Updated!\nOld Score: ${scoreChange.oldScore}\nNew Score: ${scoreChange.newScore}\nChange: ${changeText} points`);
            }
        }

        function updateDebtOptions() {
            const debtOptions = document.getElementById('debtOptions');
            debtOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (!investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card debt-card';
                
                let creditImpactText = '';
                let cardStyle = '';
                
                if (investment.isRestructured) {
                    cardStyle = 'border: 2px solid #3b82f6; background: #eff6ff;';
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">🔄 Restructured Debt - Improved Terms!</div>';
                } else if (key === 'payday') {
                    creditImpactText = '<div style="color: #10b981; font-weight: bold;">💡 Big credit score boost when paid off!</div>';
                } else if (key === 'creditcard') {
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">💡 Good credit score boost when paid off!</div>';
                } else {
                    creditImpactText = '<div style="color: #6b7280;">💡 Moderate credit score improvement</div>';
                }
                
                card.style.cssText = cardStyle;
                card.innerHTML = `
                    <h4>💳 ${investment.name}</h4>
                    <p>${investment.description}</p>
                    ${creditImpactText}
                    ${investment.isRestructured ? 
                        `<div style="font-size: 0.9em; color: #6b7280; margin: 5px 0;">
                            Original debts consolidated: 
                            ${investment.originalDebts.map(d => d.name).join(', ')}
                        </div>` : ''}
                    <div class="price-info">
                        <span class="current-price">Debt Balance: ${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to pay off" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn debt-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Pay Off
                        </button>
                    </div>
                `;
                debtOptions.appendChild(card);
            });
        }

        function updateInvestmentOptions() {
            const investmentOptions = document.getElementById('investmentOptions');
            investmentOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card';
                
                card.innerHTML = `
                    <h4>${investment.name}</h4>
                    <p>${investment.description}</p>
                    <div class="price-info">
                        <span class="current-price">${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to invest" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Invest
                        </button>
                    </div>
                `;
                investmentOptions.appendChild(card);
            });
        }

        function updatePortfolioDisplay() {
            const portfolioDiv = document.getElementById('portfolio');
            portfolioDiv.innerHTML = '';

            let hasInvestments = false;
            let hasDebts = false;

            // Show regular investments
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    hasInvestments = true;
                    const investment = gameState.investments[key];
                    const value = gameState.portfolio[key] * investment.price;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item';
                    item.innerHTML = `
                        <div>
                            <strong>${investment.name}</strong><br>
                            <small>${gameState.portfolio[key]} shares @ ${formatCurrency(investment.price)}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(value)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            // Show remaining debts
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    hasDebts = true;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item debt-item';
                    item.innerHTML = `
                        <div>
                            <strong>💳 ${investment.name}</strong><br>
                            <small>Remaining debt balance (${(investment.monthlyInterestRate * 100).toFixed(2)}% monthly interest)</small>
                        </div>
                        <div style="text-align: right; color: #ef4444;">
                            <strong>-${formatCurrency(investment.price)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            if (!hasInvestments && !hasDebts) {
                portfolioDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No investments yet and no debts remaining. Start building your portfolio!</p>';
            } else if (!hasInvestments && hasDebts) {
                portfolioDiv.innerHTML += '<p style="text-align: center; color: #ef4444; padding: 10px; font-weight: bold;">⚠️ Consider paying off high-interest debt before investing!</p>';
            }
        }

        function makeInvestment(investmentKey) {
            const amountInput = document.getElementById(`amount-${investmentKey}`);
            const amount = parseInt(amountInput.value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (amount > gameState.cash) {
                alert('Insufficient funds!');
                return;
            }

            const investment = gameState.investments[investmentKey];
            
            if (investment.isDebt) {
                // Paying off debt - reduce debt balance and update credit score
                const debtPayment = Math.min(amount, investment.price);
                const oldDebtAmount = investment.price;
                investment.price -= debtPayment;
                gameState.cash -= debtPayment;
                
                // Process credit score change
                const scoreChange = creditScoreSystem.processDebtPayment(
                    investmentKey, 
                    debtPayment, 
                    investment.price
                );
                
                if (investment.price <= 0) {
                    investment.price = 0;
                    alert(`Congratulations! You've paid off your ${investment.name}!\n\nCredit Score Impact:\nOld Score: ${scoreChange.oldScore}\nNew Score: ${scoreChange.newScore}\nChange: +${scoreChange.scoreChange} points!`);
                } else {
                    // Show credit score change for partial payments too
                    if (scoreChange.scoreChange > 0) {
                        showCreditScoreChange(scoreChange);
                    }
                }
            } else {
                // Regular investment - buy shares
                const shares = Math.floor(amount / investment.price);
                const totalCost = shares * investment.price;

                if (shares === 0) {
                    alert('Investment amount too small to purchase shares');
                    return;
                }

                gameState.cash -= totalCost;
                gameState.portfolio[investmentKey] = (gameState.portfolio[investmentKey] || 0) + shares;
            }

            amountInput.value = '';
            updateDisplay();
        }

        function nextPeriod() {
            if (gameState.period >= gameState.maxPeriods) {
                endGame();
                return;
            }

            gameState.period++;
            gameState.cash += 2000; // Add monthly income
            updatePrices();

            // Age the credit account
            creditScoreSystem.ageAccount();

            // Update news
            const randomNews = gameState.newsEvents[Math.floor(Math.random() * gameState.newsEvents.length)];
            document.getElementById('newsText').textContent = `Month ${gameState.period}: ${randomNews}`;

            updateDisplay();

            if (gameState.period >= gameState.maxPeriods) {
                document.getElementById('nextPeriodBtn').textContent = '🏁 Finish Game';
            }
        }

        function endGame() {
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const finalWorth = gameState.cash + portfolioValue - totalDebt;
            
            // Determine if player got out of debt
            const isDebtFree = totalDebt <= 0;
            const isSuccessful = finalWorth > 0;
            
            // Update popup content based on results
            const popup = document.getElementById('gameOverPopup');
            const content = document.getElementById('gameOverContent');
            const icon = content.querySelector('.game-over-icon');
            const title = content.querySelector('.game-over-title');
            const subtitle = content.querySelector('.game-over-subtitle');
            const message = content.querySelector('.game-over-message');
            
            // Set icon and styling based on success
            if (isDebtFree && isSuccessful) {
                icon.textContent = '🎉';
                title.textContent = 'Congratulations!';
                subtitle.textContent = 'You\'re completely debt-free and financially successful!';
                content.className = 'game-over-content success';
                message.innerHTML = `
                    <strong>Outstanding achievement!</strong> You've not only eliminated all your debt 
                    but also built a positive net worth. Your financial discipline and smart decision-making 
                    have paid off. You're now in an excellent financial position!
                `;
                createConfetti();
            } else if (isDebtFree) {
                icon.textContent = '✅';
                title.textContent = 'Great Job!';
                subtitle.textContent = 'You\'ve successfully eliminated all your debt!';
                content.className = 'game-over-content success';
                message.innerHTML = `
                    <strong>Excellent work!</strong> You've successfully paid off all your debts. 
                    While your net worth may be negative due to investment losses, being debt-free 
                    is a major financial milestone. You're now in a much stronger financial position!
                `;
                createConfetti();
            } else if (isSuccessful) {
                icon.textContent = '📈';
                title.textContent = 'Good Progress!';
                subtitle.textContent = 'You\'ve built positive net worth despite remaining debt.';
                content.className = 'game-over-content';
                message.innerHTML = `
                    <strong>Solid performance!</strong> You've managed to build a positive net worth 
                    even with some remaining debt. Your investment strategy has been effective. 
                    Consider focusing more on debt elimination in future games for even better results.
                `;
            } else {
                icon.textContent = '📉';
                title.textContent = 'Game Over';
                subtitle.textContent = 'You still have debt and negative net worth.';
                content.className = 'game-over-content failure';
                message.innerHTML = `
                    <strong>Room for improvement!</strong> You still have outstanding debt and negative net worth. 
                    Consider prioritizing high-interest debt payments and being more conservative with investments 
                    in your next game. Remember: debt elimination is often the best investment!
                `;
            }
            
            // Update stats
            document.getElementById('finalScore').textContent = formatCurrency(finalWorth);
            document.getElementById('finalCreditScore').textContent = creditScoreSystem.score;
            
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            document.getElementById('finalCreditRange').textContent = creditInfo.range;
            document.getElementById('finalCreditRange').style.color = creditInfo.color;
            
            // Show the animated popup
            popup.classList.add('show');
            
            // Hide game sections
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'none';
            document.getElementById('nextPeriodBtn').style.display = 'none';
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }

        function closeGameOverPopup() {
            document.getElementById('gameOverPopup').classList.remove('show');
        }

        function resetGame() {
            // Reset credit score system
            creditScoreSystem = new CreditScoreSystem();
            
            gameState = {
                cash: 5000,
                period: 1,
                maxPeriods: 30,
                portfolio: {},
                investments: {
                    stocks: { 
                        name: 'Stock Market Index', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Diversified stock market fund with moderate risk and good long-term returns',
                        volatility: 0.15 
                    },
                    bonds: { 
                        name: 'Government Bonds', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Safe government bonds with steady, low returns',
                        volatility: 0.05 
                    },
                    creditcard: { 
                        name: 'Credit Card Debt', 
                        price: 8500, 
                        basePrice: 8500,
                        description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.015
                    },
                    payday: { 
                        name: 'Payday Loan Debt', 
                        price: 1200, 
                        basePrice: 1200,
                        description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.333
                    },
                    autoloan: { 
                        name: 'Auto Loan Debt', 
                        price: 15000, 
                        basePrice: 15000,
                        description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.005
                    },
                    mortgage: { 
                        name: 'Mortgage Debt', 
                        price: 45000, 
                        basePrice: 45000,
                        description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.0033
                    }
                },
                priceHistory: {},
                newsEvents: [
                    "Market showing steady growth across all sectors.",
                    "Economic indicators suggest continued expansion.",
                    "Tech sector experiencing significant growth this month.",
                    "Interest rates remain stable, benefiting bond markets.",
                    "Financial advisors recommend paying off high-interest debt first.",
                    "Credit card interest rates continue to climb nationwide.",
                    "Auto loan rates see slight increase due to Federal Reserve policy.",
                    "Mortgage rates remain competitive for qualified borrowers.",
                    "Consumer debt reaches new highs - experts advise caution.",
                    "Payday loan regulations tighten in several states.",
                    "Real estate market shows strong fundamentals.",
                    "Global markets react to positive economic data.",
                    "Debt consolidation services see increased demand.",
                    "Financial literacy programs emphasize debt management.",
                    "Good credit scores unlock better loan terms and rates.",
                    "Credit utilization below 30% is recommended by experts.",
                    "Payment history is the most important factor in credit scoring.",
                    "Paying off debt early can significantly boost your credit score."
                ]
            };

            // Reinitialize price history
            Object.keys(gameState.investments).forEach(key => {
                gameState.priceHistory[key] = [gameState.investments[key].price];
            });

            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameOverPopup').classList.remove('show');
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'block';
            document.getElementById('nextPeriodBtn').style.display = 'inline-block';
            document.getElementById('nextPeriodBtn').textContent = '⏭️ Next Month';
            document.getElementById('newsText').textContent = 'Welcome to the investment game! You start with $5,000 and a 580 credit score. Make wise choices!';

            updateDisplay();
        }

        // Debt Restructuring System
        class DebtRestructuringSystem {
            constructor(creditScoreSystem) {
                this.creditScoreSystem = creditScoreSystem;
                this.restructuringHistory = [];
                this.availableRestructurings = 0;
                this.lastRestructuringPeriod = 0;
            }

            // Calculate available restructuring options based on credit score
            getRestructuringOptions() {
                const score = this.creditScoreSystem.score;
                const activeDebts = this.getEligibleDebts();
                
                if (activeDebts.length === 0) {
                    return { canRestructure: false, reason: "No eligible debts to restructure" };
                }

                // Check if enough time has passed since last restructuring
                const periodsSinceLastRestructuring = gameState.period - this.lastRestructuringPeriod;
                if (periodsSinceLastRestructuring < 6 && this.restructuringHistory.length > 0) {
                    return { 
                        canRestructure: false, 
                        reason: `Must wait ${6 - periodsSinceLastRestructuring} more months before restructuring again` 
                    };
                }

                let maxDebtAmount = 0;
                let newInterestRate = 0;
                let restructuringFee = 0;
                let availableTypes = [];

                if (score >= 750) {
                    // Excellent credit - Best terms
                    maxDebtAmount = this.getTotalEligibleDebt();
                    newInterestRate = 0.003; // 0.3% monthly (3.6% annual)
                    restructuringFee = 0.01; // 1% fee
                    availableTypes = ['consolidation', 'refinancing', 'balance_transfer'];
                } else if (score >= 700) {
                    // Good credit - Good terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.8;
                    newInterestRate = 0.005; // 0.5% monthly (6% annual)
                    restructuringFee = 0.02; // 2% fee
                    availableTypes = ['consolidation', 'refinancing'];
                } else if (score >= 650) {
                    // Fair credit - Moderate terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.6;
                    newInterestRate = 0.008; // 0.8% monthly (9.6% annual)
                    restructuringFee = 0.03; // 3% fee
                    availableTypes = ['consolidation'];
                } else if (score >= 600) {
                    // Poor credit - Limited options
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.4;
                    newInterestRate = 0.012; // 1.2% monthly (14.4% annual)
                    restructuringFee = 0.05; // 5% fee
                    availableTypes = ['consolidation'];
                } else {
                    // Very poor credit - No restructuring available
                    return { 
                        canRestructure: false, 
                        reason: "Credit score too low for debt restructuring (minimum 600 required)" 
                    };
                }

                return {
                    canRestructure: true,
                    maxDebtAmount: Math.floor(maxDebtAmount),
                    newInterestRate: newInterestRate,
                    restructuringFee: restructuringFee,
                    availableTypes: availableTypes,
                    eligibleDebts: activeDebts
                };
            }

            // Get debts eligible for restructuring (exclude mortgage for most cases)
            getEligibleDebts() {
                const eligibleDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        // Mortgage requires excellent credit to restructure
                        if (key === 'mortgage' && this.creditScoreSystem.score < 750) {
                            return;
                        }
                        eligibleDebts.push({
                            key: key,
                            name: investment.name,
                            balance: investment.price,
                            currentRate: investment.monthlyInterestRate
                        });
                    }
                });
                return eligibleDebts;
            }

            getTotalEligibleDebt() {
                return this.getEligibleDebts().reduce((total, debt) => total + debt.balance, 0);
            }

            // Execute debt restructuring
            executeRestructuring(selectedDebts, restructuringType) {
                const options = this.getRestructuringOptions();
                if (!options.canRestructure) {
                    return { success: false, message: options.reason };
                }

                const totalSelectedDebt = selectedDebts.reduce((sum, debtKey) => {
                    return sum + gameState.investments[debtKey].price;
                }, 0);

                if (totalSelectedDebt > options.maxDebtAmount) {
                    return { 
                        success: false, 
                        message: `Selected debt (${formatCurrency(totalSelectedDebt)}) exceeds maximum allowed (${formatCurrency(options.maxDebtAmount)})` 
                    };
                }

                // Calculate restructuring fee
                const fee = Math.floor(totalSelectedDebt * options.restructuringFee);
                if (gameState.cash < fee) {
                    return { 
                        success: false, 
                        message: `Insufficient funds to pay restructuring fee of ${formatCurrency(fee)}` 
                    };
                }

                // Execute the restructuring
                const oldDebts = [];
                selectedDebts.forEach(debtKey => {
                    const debt = gameState.investments[debtKey];
                    oldDebts.push({
                        name: debt.name,
                        balance: debt.price,
                        rate: debt.monthlyInterestRate
                    });
                    // Clear the old debt
                    debt.price = 0;
                });

                // Create new consolidated debt
                const newDebtKey = `restructured_${gameState.period}`;
                gameState.investments[newDebtKey] = {
                    name: `Restructured Debt (${restructuringType})`,
                    price: totalSelectedDebt,
                    basePrice: totalSelectedDebt,
                    description: `Consolidated debt with improved ${(options.newInterestRate * 100).toFixed(2)}% monthly interest rate`,
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: options.newInterestRate,
                    isRestructured: true,
                    originalDebts: oldDebts
                };

                // Initialize price history for new debt
                gameState.priceHistory[newDebtKey] = [totalSelectedDebt];

                // Pay the fee
                gameState.cash -= fee;

                // Record the restructuring
                this.restructuringHistory.push({
                    period: gameState.period,
                    type: restructuringType,
                    originalDebts: oldDebts,
                    newDebt: {
                        amount: totalSelectedDebt,
                        rate: options.newInterestRate
                    },
                    fee: fee,
                    creditScore: this.creditScoreSystem.score
                });

                this.lastRestructuringPeriod = gameState.period;

                // Small credit score impact for successful restructuring
                const scoreChange = this.creditScoreSystem.processDebtRestructuring(restructuringType, totalSelectedDebt);

                return {
                    success: true,
                    message: `Successfully restructured ${formatCurrency(totalSelectedDebt)} of debt!\nNew rate: ${(options.newInterestRate * 100).toFixed(2)}% monthly\nFee paid: ${formatCurrency(fee)}`,
                    scoreChange: scoreChange,
                    newDebtKey: newDebtKey
                };
            }

            getRestructuringHistory() {
                return this.restructuringHistory;
            }
        }

        // Extend CreditScoreSystem with restructuring impact
        CreditScoreSystem.prototype.processDebtRestructuring = function(restructuringType, debtAmount) {
            let scoreChange = 0;
            
            // Restructuring has mixed impact on credit score
            // Positive: Shows proactive debt management
            // Negative: Can be seen as financial stress indicator
            
            if (this.score >= 700) {
                // Good credit - minimal impact, slightly positive for proactive management
                scoreChange = Math.min(3, Math.floor(debtAmount / 10000));
            } else if (this.score >= 600) {
                // Fair credit - neutral to slightly negative impact
                scoreChange = -Math.min(2, Math.floor(debtAmount / 15000));
            } else {
                // Poor credit - more negative impact
                scoreChange = -Math.min(5, Math.floor(debtAmount / 8000));
            }

            // Type-specific adjustments
            switch(restructuringType) {
                case 'balance_transfer':
                    scoreChange += 1; // Slightly better as it's moving to lower rate
                    break;
                case 'refinancing':
                    // Neutral - no additional impact
                    break;
                case 'consolidation':
                    scoreChange -= 1; // Slightly worse as it may indicate financial stress
                    break;
            }

            const oldScore = this.score;
            this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            this.scoreHistory.push(this.score);

            return {
                oldScore: oldScore,
                newScore: this.score,
                scoreChange: scoreChange
            };
        };

        // Initialize debt restructuring system
        let debtRestructuringSystem;

        // Enhanced game initialization
        const originalResetGame = resetGame;
        resetGame = function() {
            originalResetGame();
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
            updateDisplay();
        };

        function updateRestructuringDisplay() {
            const restructuringOptions = document.getElementById('restructuringOptions');
            if (!restructuringOptions) return;
            
            const options = debtRestructuringSystem.getRestructuringOptions();
            
            if (options.canRestructure) {
                const annualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                const feePercent = (options.restructuringFee * 100).toFixed(1);
                
                restructuringOptions.innerHTML = `
                    <div class="info-card">
                        <h4>✅ Restructuring Available</h4>
                        <p><strong>Credit Score:</strong> ${creditScoreSystem.score} (${creditScoreSystem.getCreditScoreRange().range})</p>
                        <p><strong>Maximum Debt Amount:</strong> ${formatCurrency(options.maxDebtAmount)}</p>
                        <p><strong>New Interest Rate:</strong> ${(options.newInterestRate * 100).toFixed(2)}% monthly (${annualRate}% annual)</p>
                        <p><strong>Restructuring Fee:</strong> ${feePercent}% of restructured amount</p>
                        <p><strong>Available Types:</strong> ${options.availableTypes.join(', ')}</p>
                        <button class="invest-btn" onclick="showRestructuringControls()" style="margin-top: 10px;">Start Restructuring Process</button>
                    </div>
                `;
            } else {
                restructuringOptions.innerHTML = `
                    <div class="info-card">
                        <h4>❌ Restructuring Not Available</h4>
                        <p><strong>Reason:</strong> ${options.reason}</p>
                        <p><strong>Current Credit Score:</strong> ${creditScoreSystem.score}</p>
                        ${creditScoreSystem.score < 600 ? 
                            '<p style="color: #f59e0b;"><strong>Tip:</strong> Pay down debts to improve your credit score and unlock restructuring options!</p>' : 
                            ''}
                    </div>
                `;
            }
        }

        function showRestructuringControls() {
            const options = debtRestructuringSystem.getRestructuringOptions();
            const controlsDiv = document.getElementById('restructuringControls');
            const selectionDiv = document.getElementById('debtSelection');
            const typeSelect = document.getElementById('restructuringType');
            
            // Update available restructuring types
            typeSelect.innerHTML = '';
            options.availableTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                typeSelect.appendChild(option);
            });
            
            // Show eligible debts for selection
            selectionDiv.innerHTML = '';
            options.eligibleDebts.forEach(debt => {
                const debtDiv = document.createElement('div');
                debtDiv.className = 'debt-checkbox';
                
                const currentAnnualRate = (debt.currentRate * 12 * 100).toFixed(1);
                const newAnnualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                const monthlySavings = Math.floor(debt.balance * (debt.currentRate - options.newInterestRate));
                
                debtDiv.innerHTML = `
                    <input type="checkbox" name="selectedDebts" value="${debt.key}">
                    <div class="debt-checkbox-label">
                        <div class="debt-checkbox-name">${debt.name}</div>
                        <div class="debt-checkbox-details">
                            Balance: ${formatCurrency(debt.balance)}<br>
                            <span style="color: #ef4444;">Current Rate: ${currentAnnualRate}% annual</span> → 
                            <span style="color: #10b981;">New Rate: ${newAnnualRate}% annual</span><br>
                            <span style="color: #10b981; font-weight: bold;">Monthly Interest Savings: ${formatCurrency(monthlySavings)}</span>
                        </div>
                    </div>
                `;
                selectionDiv.appendChild(debtDiv);
            });
            
            controlsDiv.style.display = 'block';
            document.getElementById('restructuringOptions').style.display = 'none';
        }

        function executeRestructuring() {
            const selectedCheckboxes = document.querySelectorAll('input[name="selectedDebts"]:checked');
            const selectedDebts = Array.from(selectedCheckboxes).map(cb => cb.value);
            const restructuringType = document.getElementById('restructuringType').value;
            
            if (selectedDebts.length === 0) {
                alert('Please select at least one debt to restructure');
                return;
            }
            
            const result = debtRestructuringSystem.executeRestructuring(selectedDebts, restructuringType);
            
            if (result.success) {
                let message = result.message;
                if (result.scoreChange && result.scoreChange.scoreChange !== 0) {
                    message += `\n\nCredit Score Impact:\nOld Score: ${result.scoreChange.oldScore}\nNew Score: ${result.scoreChange.newScore}\nChange: ${result.scoreChange.scoreChange > 0 ? '+' : ''}${result.scoreChange.scoreChange} points`;
                }
                alert(message);
                cancelRestructuring();
                updateDisplay();
            } else {
                alert(`Restructuring Failed: ${result.message}`);
            }
        }

        function cancelRestructuring() {
            document.getElementById('restructuringControls').style.display = 'none';
            document.getElementById('restructuringOptions').style.display = 'block';
        }

        // Event listeners
        document.getElementById('nextPeriodBtn').addEventListener('click', nextPeriod);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('executeRestructuringBtn').addEventListener('click', executeRestructuring);
        document.querySelector('.cancel-restructuring-btn').addEventListener('click', cancelRestructuring);

        // Initialize the enhanced system
        if (typeof creditScoreSystem !== 'undefined') {
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
        }

        // Initialize game
        updateDisplay();
    </script>
</body>
</html>