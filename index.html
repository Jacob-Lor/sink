
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e1e9ff 0%, #9faddd 25%, #92b4ff 50%, #e3eeff 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .game-layout {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            gap: 24px;
            padding: 24px;
            min-height: 100vh;
        }

        .main-game {
            flex: 1;
            min-width: 0;
        }

        .sidebar {
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .sidebar h3 {
            color: #1f2937;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }

        .info-card h4 {
            color: #1e40af;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-card p {
            color: #64748b;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .tip-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .tip-card h4 {
            color: #92400e;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tip-card p {
            color: #a16207;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .progress-tracker {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .progress-tracker h4 {
            color: #1e40af;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-bar {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            height: 100%;
            width: 3.33%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        .progress-text {
            color: #1e40af;
            font-size: 0.85em;
            font-weight: 500;
            text-align: center;
        }

        .quick-stats {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 16px;
        }

        .quick-stats h4 {
            color: #166534;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .stat-label {
            color: #166534;
            font-size: 0.85em;
            font-weight: 500;
        }

        .stat-value-small {
            color: #059669;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .container {
            width: 100%;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 32px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.02em;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 28px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            border-radius: 12px 12px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .stat-card h3 {
            color: #4b5563;
            margin-bottom: 12px;
            font-size: 0.95em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1f2937;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .news-section {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 24px 28px;
            border-radius: 12px;
            margin-bottom: 32px;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .news-section h3 {
            margin-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-section p {
            font-size: 1.05em;
            line-height: 1.5;
            font-weight: 400;
        }

        .debt-section, .investment-section {
            background: white;
            padding: 36px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
        }

        .debt-section h2, .investment-section h2 {
            color: #1f2937;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .debt-section h2 {
            color: #dc2626;
            border-bottom-color: #fecaca;
        }

        .debt-options, .investment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .investment-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            background: #fafafa;
            position: relative;
            overflow: hidden;
        }

        .investment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .investment-card:hover::before {
            opacity: 1;
        }

        .investment-card:hover {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15);
            background: white;
        }

        .investment-card.debt-card {
            border: 2px solid #fca5a5;
            background: #fef2f2;
        }

        .investment-card.debt-card::before {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .investment-card.debt-card:hover {
            border-color: #dc2626;
            box-shadow: 0 12px 40px rgba(220, 38, 38, 0.15);
            background: #fefefe;
        }

        .investment-card h4 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 1.25em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debt-card h4 {
            color: #dc2626;
        }

        .investment-card p {
            margin-bottom: 20px;
            color: #6b7280;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .debt-card .price-info {
            background: rgba(220, 38, 38, 0.05);
            border-color: rgba(220, 38, 38, 0.1);
        }

        .current-price {
            font-weight: 700;
            color: #1f2937;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 1.1em;
        }

        .price-change {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .price-up {
            color: #059669;
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }

        .price-down {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        .investment-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .amount-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: all 0.3s ease;
            background: white;
        }

        .amount-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .invest-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            min-width: 120px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invest-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
        }

        .invest-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .debt-btn {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .debt-btn:hover {
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
            background: linear-gradient(135deg, #b91c1c, #dc2626);
        }

        .portfolio-section {
            background: white;
            padding: 36px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
        }

        .portfolio-section h2 {
            color: #1f2937;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
        }

        .portfolio-item:hover {
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.02), transparent);
            padding-left: 12px;
            padding-right: 12px;
            border-radius: 8px;
        }

        .portfolio-item:last-child {
            border-bottom: none;
        }

        .portfolio-item strong {
            font-weight: 600;
            color: #1f2937;
        }

        .portfolio-item small {
            color: #6b7280;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .debt-item {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.02), rgba(220, 38, 38, 0.05), rgba(220, 38, 38, 0.02));
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 8px 0;
        }

        .controls {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .next-period-btn {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
        }

        .next-period-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.3);
            background: linear-gradient(135deg, #047857, #059669);
        }

        .reset-btn {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(107, 114, 128, 0.3);
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }

        .game-over {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 48px 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 64px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .game-over h2 {
            font-size: 2.8em;
            margin-bottom: 24px;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .final-score {
            font-size: 3.5em;
            font-weight: 800;
            margin: 24px 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            letter-spacing: -0.02em;
        }

        .game-over p {
            font-size: 1.2em;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        /* Professional banking-style enhancements */
        .stat-card:nth-child(1) .stat-value { color: #059669; }
        .stat-card:nth-child(2) .stat-value { color: #3b82f6; }
        .stat-card:nth-child(3) .stat-value { color: #7c3aed; }
        .stat-card:nth-child(4) .stat-value { color: #f59e0b; }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .game-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .game-layout {
                padding: 16px;
                gap: 16px;
            }
            
            .sidebar {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .debt-options, .investment-options {
                grid-template-columns: 1fr;
            }
            
            .investment-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .amount-input {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .next-period-btn, .reset-btn {
                width: 100%;
                max-width: 280px;
            }
            
            .debt-section, .investment-section, .portfolio-section {
                padding: 24px 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 24px 16px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .final-score {
                font-size: 2.5em;
            }
            
            .game-over {
                padding: 32px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="game-layout">
        <div class="main-game">
            <div class="container">
                <div class="header">
                    <h1>üìà Build Your Portfolio</h1>
                    <p>Make smart investment decisions over 30 months and watch your money grow!</p>
                </div>

                <div class="game-stats">
                    <div class="stat-card">
                        <h3>üí∞ Available Cash</h3>
                        <div class="stat-value" id="cash">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìä Investment Value</h3>
                        <div class="stat-value" id="portfolioValue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>üíé Total Worth</h3>
                        <div class="stat-value" id="totalWorth">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìÖ Month</h3>
                        <div class="stat-value" id="period">1 / 30</div>
                    </div>
                </div>

                <div class="news-section" id="newsSection">
                    <h3>üì∞ Market News</h3>
                    <p id="newsText">Welcome to the investment game! You start with $5,000. Make wise choices!</p>
                </div>

                <div class="debt-section" id="debtSection">
                    <h2>üí≥ Debt Options</h2>
                    <div class="debt-options" id="debtOptions">
                        <!-- Debt cards will be generated here -->
                    </div>
                </div>

                <div class="investment-section" id="investmentSection" style="display: none;">
                    <h2>üíº Investment Options</h2>
                    <div class="investment-options" id="investmentOptions">
                        <!-- Investment cards will be generated here -->
                    </div>
                </div>

                <div class="portfolio-section">
                    <h2>üìã Your Portfolio</h2>
                    <div id="portfolio">
                        <p style="text-align: center; color: #666; padding: 20px;">No investments yet. Start building your portfolio!</p>
                    </div>
                </div>

                <div class="controls">
                    <button class="next-period-btn" id="nextPeriodBtn">‚è≠Ô∏è Next Month</button>
                    <button class="reset-btn" id="resetBtn">üîÑ Reset Game</button>
                </div>

                <div class="game-over" id="gameOver" style="display: none;">
                    <h2>üéâ Game Complete!</h2>
                    <div class="final-score" id="finalScore">$0</div>
                    <p>You've completed 30 months of investing!</p>
                    <button class="reset-btn" onclick="resetGame()" style="margin-top: 20px;">Play Again</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>üéØ Game Info</h3>
            <!-- Credit Score Section (add this to your HTML) -->
            <div class="stats-section" style="background: repeating-linear-gradient(90deg, #d3d3d3, #8e8d8d 1px, #c0c0c0 2px); background-blend-mode: multiply; color: white; margin: 20px 0; padding: 20px; border-radius: 10px; border: solid;">
                <h3 style="margin: 0 0 15px 0; color: white;">üìä Credit Score</h3>
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold;" id="creditScore">580</div>
                        <div style="font-size: 14px; font-weight: bold;" id="creditRange">Fair</div>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 14px; margin-bottom: 10px;" id="creditDescription">Your credit is fair - keep improving!</div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; font-size: 12px;" id="creditFactors">
                            <!-- Credit factors will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="progress-tracker">
                <h4>üìä Progress</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Month 1 of 30</div>
            </div>

            <div class="quick-stats">
                <h4>‚ö° Quick Stats</h4>
                <div class="stat-row">
                    <span class="stat-label">Return Rate:</span>
                    <span class="stat-value-small" id="returnRate">0.0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Month:</span>
                    <span class="stat-value-small" id="bestMonth">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Worst Month:</span>
                    <span class="stat-value-small" id="worstMonth">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Risk Level:</span>
                    <span class="stat-value-small" id="riskLevel">Low</span>
                </div>
            </div>
            <div class="tip-card">
                <h4>‚ö†Ô∏è Strategy Tip</h4>
                <p>Don't put all your money into one investment. Spread your risk across multiple options for better long-term results.</p>
            </div>
        </div>
    </div>
    <script>
// Credit Score System Class
        class CreditScoreSystem {
            constructor() {
                this.score = 580; // Starting with fair credit
                this.paymentHistory = [];
                this.accountAge = 12; // Start with 1 year credit history
                this.consecutiveOnTimePayments = 0;
                this.totalPaymentsMade = 0;
                this.latePayments = 0;
                this.totalDebtPaidOff = 0;
                this.initialTotalDebt = 0;
                this.creditUtilization = 0;
                this.scoreHistory = [580];
                
                // Calculate initial debt for utilization tracking
                this.calculateInitialDebt();
            }

            calculateInitialDebt() {
                this.initialTotalDebt = 8500 + 1200 + 15000 + 45000; // Sum of all initial debts
            }

            // Calculate current credit utilization ratio
            calculateCreditUtilization() {
                const currentTotalDebt = this.getCurrentTotalDebt();
                const creditCardDebt = gameState.investments.creditcard.price;
                const creditCardLimit = 10000; // Assume $10k credit limit
                
                if (creditCardLimit > 0) {
                    this.creditUtilization = (creditCardDebt / creditCardLimit) * 100;
                } else {
                    this.creditUtilization = 0;
                }
                
                return this.creditUtilization;
            }

            getCurrentTotalDebt() {
                let totalDebt = 0;
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        totalDebt += investment.price;
                    }
                });
                return totalDebt;
            }

            // Process a debt payment and update credit score
            processDebtPayment(debtType, paymentAmount, debtRemaining) {
                const payment = {
                    debtType: debtType,
                    amount: paymentAmount,
                    remainingDebt: debtRemaining,
                    date: gameState.period,
                    onTime: true // Assume all payments in game are on time
                };

                this.paymentHistory.push(payment);
                this.totalPaymentsMade++;
                this.consecutiveOnTimePayments++;
                this.totalDebtPaidOff += paymentAmount;

                // Calculate score change
                const oldScore = this.score;
                this.updateCreditScore(payment);
                const scoreChange = this.score - oldScore;

                // Add to score history
                this.scoreHistory.push(this.score);

                return {
                    oldScore: oldScore,
                    newScore: this.score,
                    scoreChange: scoreChange
                };
            }

            updateCreditScore(payment) {
                let scoreChange = 0;

                // 1. Payment History (35% of score) - Most important factor
                if (payment.onTime) {
                    // Base points for making payment
                    scoreChange += Math.min(3, payment.amount / 1000); // Up to 3 points per $1000 paid
                    
                    // Bonus for consecutive payments
                    if (this.consecutiveOnTimePayments >= 6) {
                        scoreChange += 2; // Bonus for payment consistency
                    }
                    
                    // Extra bonus for paying off high-interest debt
                    if (payment.debtType === 'payday' && payment.remainingDebt === 0) {
                        scoreChange += 15; // Big boost for paying off payday loans
                    } else if (payment.debtType === 'creditcard' && payment.remainingDebt === 0) {
                        scoreChange += 12; // Good boost for paying off credit cards
                    }
                }

                // 2. Credit Utilization (30% of score)
                const utilizationChange = this.calculateUtilizationScoreChange();
                scoreChange += utilizationChange;

                // 3. Length of Credit History (15% of score)
                this.accountAge++; // Age increases each period
                if (this.accountAge % 12 === 0) { // Every year
                    scoreChange += 1;
                }

                // 4. Types of Credit (10% of score)
                const debtTypesRemaining = this.getActiveDebtTypes();
                if (debtTypesRemaining.length < 4) { // Fewer debt types is better
                    scoreChange += 1;
                }

                // 5. New Credit (10% of score) - Not applicable in this game

                // Apply diminishing returns for very high scores
                if (this.score >= 750) {
                    scoreChange *= 0.5; // Harder to improve excellent credit
                } else if (this.score >= 700) {
                    scoreChange *= 0.7; // Somewhat harder to improve good credit
                }

                // Apply the change
                this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            }

            calculateUtilizationScoreChange() {
                const currentUtilization = this.calculateCreditUtilization();
                let scoreChange = 0;

                // Credit utilization brackets with score impacts
                if (currentUtilization === 0) {
                    scoreChange += 3; // Best utilization
                } else if (currentUtilization <= 10) {
                    scoreChange += 2; // Excellent utilization
                } else if (currentUtilization <= 30) {
                    scoreChange += 1; // Good utilization
                } else if (currentUtilization <= 50) {
                    scoreChange += 0; // Fair utilization
                } else if (currentUtilization <= 75) {
                    scoreChange -= 1; // Poor utilization
                } else {
                    scoreChange -= 2; // Very poor utilization
                }

                return scoreChange;
            }

            getActiveDebtTypes() {
                const activeDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        activeDebts.push(key);
                    }
                });
                return activeDebts;
            }

            getCreditScoreRange() {
                if (this.score >= 800) return { range: "Excellent", color: "#10b981", description: "You have exceptional credit!" };
                if (this.score >= 740) return { range: "Very Good", color: "#059669", description: "You have very good credit!" };
                if (this.score >= 670) return { range: "Good", color: "#3b82f6", description: "You have good credit!" };
                if (this.score >= 580) return { range: "Fair", color: "#f59e0b", description: "Your credit is fair - keep improving!" };
                return { range: "Poor", color: "#ef4444", description: "Your credit needs work - focus on debt payments!" };
            }

            // Age credit history each period
            ageAccount() {
                this.accountAge++;
                
                // Small score boost for account aging (every 6 months)
                if (this.accountAge % 6 === 0 && this.score < 800) {
                    this.score = Math.min(850, this.score + 1);
                    this.scoreHistory.push(this.score);
                }
            }

            getScoreFactors() {
                const utilization = this.calculateCreditUtilization();
                const activeDebts = this.getActiveDebtTypes().length;
                
                return {
                    paymentHistory: `${this.consecutiveOnTimePayments} consecutive on-time payments`,
                    creditUtilization: `${utilization.toFixed(1)}% utilization`,
                    creditHistory: `${Math.floor(this.accountAge / 12)} years, ${this.accountAge % 12} months`,
                    creditMix: `${activeDebts} active debt accounts`,
                    totalPaid: `$${this.totalDebtPaidOff.toLocaleString()} total debt paid off`
                };
            }
        }

        // Initialize credit score system
        let creditScoreSystem = new CreditScoreSystem();

        // Game state (existing code with credit score integration)
        let gameState = {
            cash: 5000,
            period: 1,
            maxPeriods: 30,
            portfolio: {},
            investments: {
                stocks: { 
                    name: 'Stock Market Index', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Diversified stock market fund with moderate risk and good long-term returns',
                    volatility: 0.15 
                },
                bonds: { 
                    name: 'Government Bonds', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Safe government bonds with steady, low returns',
                    volatility: 0.05 
                },
                creditcard: { 
                    name: 'Credit Card Debt', 
                    price: 8500, 
                    basePrice: 8500,
                    description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.015
                },
                payday: { 
                    name: 'Payday Loan Debt', 
                    price: 1200, 
                    basePrice: 1200,
                    description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.333
                },
                autoloan: { 
                    name: 'Auto Loan Debt', 
                    price: 15000, 
                    basePrice: 15000,
                    description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.005
                },
                mortgage: { 
                    name: 'Mortgage Debt', 
                    price: 45000, 
                    basePrice: 45000,
                    description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.0033
                }
            },
            priceHistory: {},
            newsEvents: [
                "Market showing steady growth across all sectors.",
                "Economic indicators suggest continued expansion.",
                "Tech sector experiencing significant growth this month.",
                "Interest rates remain stable, benefiting bond markets.",
                "Financial advisors recommend paying off high-interest debt first.",
                "Credit card interest rates continue to climb nationwide.",
                "Auto loan rates see slight increase due to Federal Reserve policy.",
                "Mortgage rates remain competitive for qualified borrowers.",
                "Consumer debt reaches new highs - experts advise caution.",
                "Payday loan regulations tighten in several states.",
                "Real estate market shows strong fundamentals.",
                "Global markets react to positive economic data.",
                "Debt consolidation services see increased demand.",
                "Financial literacy programs emphasize debt management.",
                "Good credit scores unlock better loan terms and rates.",
                "Credit utilization below 30% is recommended by experts.",
                "Payment history is the most important factor in credit scoring.",
                "Paying off debt early can significantly boost your credit score."
            ]
        };

        // Initialize price history
        Object.keys(gameState.investments).forEach(key => {
            gameState.priceHistory[key] = [gameState.investments[key].price];
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updatePrices() {
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) {
                    // Debt grows with monthly interest
                    investment.price = Math.round(investment.price * (1 + investment.monthlyInterestRate));
                } else {
                    // Regular investments fluctuate with market volatility
                    const change = (Math.random() - 0.5) * 2 * investment.volatility;
                    const newPrice = Math.max(investment.price * (1 + change), 10);
                    investment.price = Math.round(newPrice);
                }
                gameState.priceHistory[key].push(investment.price);
            });
        }

        function calculatePortfolioValue() {
            let totalValue = 0;
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    totalValue += gameState.portfolio[key] * gameState.investments[key].price;
                }
            });
            return totalValue;
        }

        function calculateTotalDebt() {
            let totalDebt = 0;
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    totalDebt += investment.price;
                }
            });
            return totalDebt;
        }

        function updateDisplay() {
            document.getElementById('cash').textContent = formatCurrency(gameState.cash);
            document.getElementById('period').textContent = `${gameState.period} / ${gameState.maxPeriods}`;
            
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const netWorth = gameState.cash + portfolioValue - totalDebt;
            
            document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalWorth').textContent = formatCurrency(netWorth);

            // Update credit score display
            updateCreditScoreDisplay();

            // Show/hide investment options based on round
            const investmentSection = document.getElementById('investmentSection');
            if (gameState.period >= 5) {
                investmentSection.style.display = 'block';
                updateInvestmentOptions();
            } else {
                investmentSection.style.display = 'none';
            }

            // Update debt options
            updateDebtOptions();
            updatePortfolioDisplay();
        }

        function updateCreditScoreDisplay() {
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            const creditScoreElement = document.getElementById('creditScore');
            const creditRangeElement = document.getElementById('creditRange');
            const creditDescElement = document.getElementById('creditDescription');
            
            if (creditScoreElement) {
                creditScoreElement.textContent = creditScoreSystem.score;
                creditScoreElement.style.color = creditInfo.color;
            }
            
            if (creditRangeElement) {
                creditRangeElement.textContent = creditInfo.range;
                creditRangeElement.style.color = creditInfo.color;
            }
            
            if (creditDescElement) {
                creditDescElement.textContent = creditInfo.description;
            }

            // Update credit factors if element exists
            const factorsElement = document.getElementById('creditFactors');
            if (factorsElement) {
                const factors = creditScoreSystem.getScoreFactors();
                factorsElement.innerHTML = `
                    <div><strong>Payment History:</strong> ${factors.paymentHistory}</div>
                    <div><strong>Credit Utilization:</strong> ${factors.creditUtilization}</div>
                    <div><strong>Credit History:</strong> ${factors.creditHistory}</div>
                    <div><strong>Active Debts:</strong> ${factors.creditMix}</div>
                    <div><strong>Total Paid:</strong> ${factors.totalPaid}</div>
                `;
            }
        }

        function showCreditScoreChange(scoreChange) {
            if (scoreChange.scoreChange !== 0) {
                const changeText = scoreChange.scoreChange > 0 ? 
                    `+${scoreChange.scoreChange}` : `${scoreChange.scoreChange}`;
                
                alert(`Credit Score Updated!\nOld Score: ${scoreChange.oldScore}\nNew Score: ${scoreChange.newScore}\nChange: ${changeText} points`);
            }
        }

        function updateDebtOptions() {
            const debtOptions = document.getElementById('debtOptions');
            debtOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (!investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card debt-card';
                
                let creditImpactText = '';
                if (key === 'payday') {
                    creditImpactText = '<div style="color: #10b981; font-weight: bold;">üí° Big credit score boost when paid off!</div>';
                } else if (key === 'creditcard') {
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">üí° Good credit score boost when paid off!</div>';
                } else {
                    creditImpactText = '<div style="color: #6b7280;">üí° Moderate credit score improvement</div>';
                }
                
                card.innerHTML = `
                    <h4>üí≥ ${investment.name}</h4>
                    <p>${investment.description}</p>
                    ${creditImpactText}
                    <div class="price-info">
                        <span class="current-price">Debt Balance: ${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to pay off" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn debt-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Pay Off
                        </button>
                    </div>
                `;
                debtOptions.appendChild(card);
            });
        }

        function updateInvestmentOptions() {
            const investmentOptions = document.getElementById('investmentOptions');
            investmentOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card';
                
                card.innerHTML = `
                    <h4>${investment.name}</h4>
                    <p>${investment.description}</p>
                    <div class="price-info">
                        <span class="current-price">${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to invest" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Invest
                        </button>
                    </div>
                `;
                investmentOptions.appendChild(card);
            });
        }

        function updatePortfolioDisplay() {
            const portfolioDiv = document.getElementById('portfolio');
            portfolioDiv.innerHTML = '';

            let hasInvestments = false;
            let hasDebts = false;

            // Show regular investments
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    hasInvestments = true;
                    const investment = gameState.investments[key];
                    const value = gameState.portfolio[key] * investment.price;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item';
                    item.innerHTML = `
                        <div>
                            <strong>${investment.name}</strong><br>
                            <small>${gameState.portfolio[key]} shares @ ${formatCurrency(investment.price)}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(value)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            // Show remaining debts
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    hasDebts = true;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item debt-item';
                    item.innerHTML = `
                        <div>
                            <strong>üí≥ ${investment.name}</strong><br>
                            <small>Remaining debt balance (${(investment.monthlyInterestRate * 100).toFixed(2)}% monthly interest)</small>
                        </div>
                        <div style="text-align: right; color: #ef4444;">
                            <strong>-${formatCurrency(investment.price)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            if (!hasInvestments && !hasDebts) {
                portfolioDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No investments yet and no debts remaining. Start building your portfolio!</p>';
            } else if (!hasInvestments && hasDebts) {
                portfolioDiv.innerHTML += '<p style="text-align: center; color: #ef4444; padding: 10px; font-weight: bold;">‚ö†Ô∏è Consider paying off high-interest debt before investing!</p>';
            }
        }

        function makeInvestment(investmentKey) {
            const amountInput = document.getElementById(`amount-${investmentKey}`);
            const amount = parseInt(amountInput.value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (amount > gameState.cash) {
                alert('Insufficient funds!');
                return;
            }

            const investment = gameState.investments[investmentKey];
            
            if (investment.isDebt) {
                // Paying off debt - reduce debt balance and update credit score
                const debtPayment = Math.min(amount, investment.price);
                const oldDebtAmount = investment.price;
                investment.price -= debtPayment;
                gameState.cash -= debtPayment;
                
                // Process credit score change
                const scoreChange = creditScoreSystem.processDebtPayment(
                    investmentKey, 
                    debtPayment, 
                    investment.price
                );
                
                if (investment.price <= 0) {
                    investment.price = 0;
                    alert(`Congratulations! You've paid off your ${investment.name}!\n\nCredit Score Impact:\nOld Score: ${scoreChange.oldScore}\nNew Score: ${scoreChange.newScore}\nChange: +${scoreChange.scoreChange} points!`);
                } else {
                    // Show credit score change for partial payments too
                    if (scoreChange.scoreChange > 0) {
                        showCreditScoreChange(scoreChange);
                    }
                }
            } else {
                // Regular investment - buy shares
                const shares = Math.floor(amount / investment.price);
                const totalCost = shares * investment.price;

                if (shares === 0) {
                    alert('Investment amount too small to purchase shares');
                    return;
                }

                gameState.cash -= totalCost;
                gameState.portfolio[investmentKey] = (gameState.portfolio[investmentKey] || 0) + shares;
            }

            amountInput.value = '';
            updateDisplay();
        }

        function nextPeriod() {
            if (gameState.period >= gameState.maxPeriods) {
                endGame();
                return;
            }

            gameState.period++;
            gameState.cash += 2000; // Add monthly income
            updatePrices();

            // Age the credit account
            creditScoreSystem.ageAccount();

            // Update news
            const randomNews = gameState.newsEvents[Math.floor(Math.random() * gameState.newsEvents.length)];
            document.getElementById('newsText').textContent = `Month ${gameState.period}: ${randomNews}`;

            updateDisplay();

            if (gameState.period >= gameState.maxPeriods) {
                document.getElementById('nextPeriodBtn').textContent = 'üèÅ Finish Game';
            }
        }

        function endGame() {
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const finalWorth = gameState.cash + portfolioValue - totalDebt;
            
            document.getElementById('finalScore').textContent = formatCurrency(finalWorth);
            document.getElementById('finalCreditScore').textContent = creditScoreSystem.score;
            
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            document.getElementById('finalCreditRange').textContent = creditInfo.range;
            document.getElementById('finalCreditRange').style.color = creditInfo.color;
            
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'none';
            document.getElementById('nextPeriodBtn').style.display = 'none';
        }

        function resetGame() {
            // Reset credit score system
            creditScoreSystem = new CreditScoreSystem();
            
            gameState = {
                cash: 5000,
                period: 1,
                maxPeriods: 30,
                portfolio: {},
                investments: {
                    stocks: { 
                        name: 'Stock Market Index', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Diversified stock market fund with moderate risk and good long-term returns',
                        volatility: 0.15 
                    },
                    bonds: { 
                        name: 'Government Bonds', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Safe government bonds with steady, low returns',
                        volatility: 0.05 
                    },
                    creditcard: { 
                        name: 'Credit Card Debt', 
                        price: 8500, 
                        basePrice: 8500,
                        description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.015
                    },
                    payday: { 
                        name: 'Payday Loan Debt', 
                        price: 1200, 
                        basePrice: 1200,
                        description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.333
                    },
                    autoloan: { 
                        name: 'Auto Loan Debt', 
                        price: 15000, 
                        basePrice: 15000,
                        description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.005
                    },
                    mortgage: { 
                        name: 'Mortgage Debt', 
                        price: 45000, 
                        basePrice: 45000,
                        description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.0033
                    }
                },
                priceHistory: {},
                newsEvents: [
                    "Market showing steady growth across all sectors.",
                    "Economic indicators suggest continued expansion.",
                    "Tech sector experiencing significant growth this month.",
                    "Interest rates remain stable, benefiting bond markets.",
                    "Financial advisors recommend paying off high-interest debt first.",
                    "Credit card interest rates continue to climb nationwide.",
                    "Auto loan rates see slight increase due to Federal Reserve policy.",
                    "Mortgage rates remain competitive for qualified borrowers.",
                    "Consumer debt reaches new highs - experts advise caution.",
                    "Payday loan regulations tighten in several states.",
                    "Real estate market shows strong fundamentals.",
                    "Global markets react to positive economic data.",
                    "Debt consolidation services see increased demand.",
                    "Financial literacy programs emphasize debt management.",
                    "Good credit scores unlock better loan terms and rates.",
                    "Credit utilization below 30% is recommended by experts.",
                    "Payment history is the most important factor in credit scoring.",
                    "Paying off debt early can significantly boost your credit score."
                ]
            };

            // Reinitialize price history
            Object.keys(gameState.investments).forEach(key => {
                gameState.priceHistory[key] = [gameState.investments[key].price];
            });

            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'block';
            document.getElementById('nextPeriodBtn').style.display = 'inline-block';
            document.getElementById('nextPeriodBtn').textContent = '‚è≠Ô∏è Next Month';
            document.getElementById('newsText').textContent = 'Welcome to the investment game! You start with $5,000 and a 580 credit score. Make wise choices!';

            updateDisplay();
        }

        // Event listeners
        document.getElementById('nextPeriodBtn').addEventListener('click', nextPeriod);
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        // Debt Restructuring System Enhancement
        class DebtRestructuringSystem {
            constructor(creditScoreSystem) {
                this.creditScoreSystem = creditScoreSystem;
                this.restructuringHistory = [];
                this.availableRestructurings = 0;
                this.lastRestructuringPeriod = 0;
            }

            // Calculate available restructuring options based on credit score
            getRestructuringOptions() {
                const score = this.creditScoreSystem.score;
                const activeDebts = this.getEligibleDebts();
                
                if (activeDebts.length === 0) {
                    return { canRestructure: false, reason: "No eligible debts to restructure" };
                }

                // Check if enough time has passed since last restructuring
                const periodsSinceLastRestructuring = gameState.period - this.lastRestructuringPeriod;
                if (periodsSinceLastRestructuring < 6 && this.restructuringHistory.length > 0) {
                    return { 
                        canRestructure: false, 
                        reason: `Must wait ${6 - periodsSinceLastRestructuring} more months before restructuring again` 
                    };
                }

                let maxDebtAmount = 0;
                let newInterestRate = 0;
                let restructuringFee = 0;
                let availableTypes = [];

                if (score >= 750) {
                    // Excellent credit - Best terms
                    maxDebtAmount = this.getTotalEligibleDebt();
                    newInterestRate = 0.003; // 0.3% monthly (3.6% annual)
                    restructuringFee = 0.01; // 1% fee
                    availableTypes = ['consolidation', 'refinancing', 'balance_transfer'];
                } else if (score >= 700) {
                    // Good credit - Good terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.8;
                    newInterestRate = 0.005; // 0.5% monthly (6% annual)
                    restructuringFee = 0.02; // 2% fee
                    availableTypes = ['consolidation', 'refinancing'];
                } else if (score >= 650) {
                    // Fair credit - Moderate terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.6;
                    newInterestRate = 0.008; // 0.8% monthly (9.6% annual)
                    restructuringFee = 0.03; // 3% fee
                    availableTypes = ['consolidation'];
                } else if (score >= 600) {
                    // Poor credit - Limited options
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.4;
                    newInterestRate = 0.012; // 1.2% monthly (14.4% annual)
                    restructuringFee = 0.05; // 5% fee
                    availableTypes = ['consolidation'];
                } else {
                    // Very poor credit - No restructuring available
                    return { 
                        canRestructure: false, 
                        reason: "Credit score too low for debt restructuring (minimum 600 required)" 
                    };
                }

                return {
                    canRestructure: true,
                    maxDebtAmount: Math.floor(maxDebtAmount),
                    newInterestRate: newInterestRate,
                    restructuringFee: restructuringFee,
                    availableTypes: availableTypes,
                    eligibleDebts: activeDebts
                };
            }

            // Get debts eligible for restructuring (exclude mortgage for most cases)
            getEligibleDebts() {
                const eligibleDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        // Mortgage requires excellent credit to restructure
                        if (key === 'mortgage' && this.creditScoreSystem.score < 750) {
                            return;
                        }
                        eligibleDebts.push({
                            key: key,
                            name: investment.name,
                            balance: investment.price,
                            currentRate: investment.monthlyInterestRate
                        });
                    }
                });
                return eligibleDebts;
            }

            getTotalEligibleDebt() {
                return this.getEligibleDebts().reduce((total, debt) => total + debt.balance, 0);
            }

            // Execute debt restructuring
            executeRestructuring(selectedDebts, restructuringType) {
                const options = this.getRestructuringOptions();
                if (!options.canRestructure) {
                    return { success: false, message: options.reason };
                }

                const totalSelectedDebt = selectedDebts.reduce((sum, debtKey) => {
                    return sum + gameState.investments[debtKey].price;
                }, 0);

                if (totalSelectedDebt > options.maxDebtAmount) {
                    return { 
                        success: false, 
                        message: `Selected debt (${formatCurrency(totalSelectedDebt)}) exceeds maximum allowed (${formatCurrency(options.maxDebtAmount)})` 
                    };
                }

                // Calculate restructuring fee
                const fee = Math.floor(totalSelectedDebt * options.restructuringFee);
                if (gameState.cash < fee) {
                    return { 
                        success: false, 
                        message: `Insufficient funds to pay restructuring fee of ${formatCurrency(fee)}` 
                    };
                }

                // Execute the restructuring
                const oldDebts = [];
                selectedDebts.forEach(debtKey => {
                    const debt = gameState.investments[debtKey];
                    oldDebts.push({
                        name: debt.name,
                        balance: debt.price,
                        rate: debt.monthlyInterestRate
                    });
                    // Clear the old debt
                    debt.price = 0;
                });

                // Create new consolidated debt
                const newDebtKey = `restructured_${gameState.period}`;
                gameState.investments[newDebtKey] = {
                    name: `Restructured Debt (${restructuringType})`,
                    price: totalSelectedDebt,
                    basePrice: totalSelectedDebt,
                    description: `Consolidated debt with improved ${(options.newInterestRate * 100).toFixed(2)}% monthly interest rate`,
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: options.newInterestRate,
                    isRestructured: true,
                    originalDebts: oldDebts
                };

                // Initialize price history for new debt
                gameState.priceHistory[newDebtKey] = [totalSelectedDebt];

                // Pay the fee
                gameState.cash -= fee;

                // Record the restructuring
                this.restructuringHistory.push({
                    period: gameState.period,
                    type: restructuringType,
                    originalDebts: oldDebts,
                    newDebt: {
                        amount: totalSelectedDebt,
                        rate: options.newInterestRate
                    },
                    fee: fee,
                    creditScore: this.creditScoreSystem.score
                });

                this.lastRestructuringPeriod = gameState.period;

                // Small credit score impact for successful restructuring
                const scoreChange = this.creditScoreSystem.processDebtRestructuring(restructuringType, totalSelectedDebt);

                return {
                    success: true,
                    message: `Successfully restructured ${formatCurrency(totalSelectedDebt)} of debt!\nNew rate: ${(options.newInterestRate * 100).toFixed(2)}% monthly\nFee paid: ${formatCurrency(fee)}`,
                    scoreChange: scoreChange,
                    newDebtKey: newDebtKey
                };
            }

            getRestructuringHistory() {
                return this.restructuringHistory;
            }
        }

        // Extend CreditScoreSystem with restructuring impact
        CreditScoreSystem.prototype.processDebtRestructuring = function(restructuringType, debtAmount) {
            let scoreChange = 0;
            
            // Restructuring has mixed impact on credit score
            // Positive: Shows proactive debt management
            // Negative: Can be seen as financial stress indicator
            
            if (this.score >= 700) {
                // Good credit - minimal impact, slightly positive for proactive management
                scoreChange = Math.min(3, Math.floor(debtAmount / 10000));
            } else if (this.score >= 600) {
                // Fair credit - neutral to slightly negative impact
                scoreChange = -Math.min(2, Math.floor(debtAmount / 15000));
            } else {
                // Poor credit - more negative impact
                scoreChange = -Math.min(5, Math.floor(debtAmount / 8000));
            }

            // Type-specific adjustments
            switch(restructuringType) {
                case 'balance_transfer':
                    scoreChange += 1; // Slightly better as it's moving to lower rate
                    break;
                case 'refinancing':
                    // Neutral - no additional impact
                    break;
                case 'consolidation':
                    scoreChange -= 1; // Slightly worse as it may indicate financial stress
                    break;
            }

            const oldScore = this.score;
            this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            this.scoreHistory.push(this.score);

            return {
                oldScore: oldScore,
                newScore: this.score,
                scoreChange: scoreChange
            };
        };

        // Initialize debt restructuring system
        let debtRestructuringSystem;

        // Enhanced game initialization
        const originalResetGame = resetGame;
        resetGame = function() {
            originalResetGame();
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
            updateDisplay();
        };

        // Enhanced display update to include restructuring options
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function() {
            originalUpdateDisplay();
            updateRestructuringDisplay();
        };

        function updateRestructuringDisplay() {
            // Add restructuring section if it doesn't exist
            let restructuringSection = document.getElementById('restructuringSection');
            if (!restructuringSection) {
                const debtSection = document.getElementById('debtSection');
                if (debtSection) {
                    restructuringSection = document.createElement('div');
                    restructuringSection.id = 'restructuringSection';
                    restructuringSection.className = 'section';
                    restructuringSection.innerHTML = `
                        <h3>üí≥ Debt Restructuring</h3>
                        <p>Consolidate or refinance your debts for better terms based on your credit score</p>
                        <div id="restructuringOptions"></div>
                        <div id="restructuringControls" style="display: none;">
                            <h4>Select Debts to Restructure:</h4>
                            <div id="debtSelection"></div>
                            <div style="margin-top: 15px;">
                                <label for="restructuringType">Restructuring Type:</label>
                                <select id="restructuringType">
                                    <option value="consolidation">Debt Consolidation</option>
                                    <option value="refinancing">Refinancing</option>
                                    <option value="balance_transfer">Balance Transfer</option>
                                </select>
                            </div>
                            <div style="margin-top: 15px;">
                                <button id="executeRestructuringBtn" onclick="executeRestructuring()">Execute Restructuring</button>
                                <button onclick="cancelRestructuring()">Cancel</button>
                            </div>
                        </div>
                    `;
                    debtSection.parentNode.insertBefore(restructuringSection, debtSection.nextSibling);
                }
            }

            if (restructuringSection && debtRestructuringSystem) {
                const options = debtRestructuringSystem.getRestructuringOptions();
                const optionsDiv = document.getElementById('restructuringOptions');
                
                if (options.canRestructure) {
                    const annualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                    const feePercent = (options.restructuringFee * 100).toFixed(1);
                    
                    optionsDiv.innerHTML = `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #10b981; margin-top: 0;">‚úÖ Restructuring Available</h4>
                            <p><strong>Credit Score:</strong> ${creditScoreSystem.score} (${creditScoreSystem.getCreditScoreRange().range})</p>
                            <p><strong>Maximum Debt Amount:</strong> ${formatCurrency(options.maxDebtAmount)}</p>
                            <p><strong>New Interest Rate:</strong> ${(options.newInterestRate * 100).toFixed(2)}% monthly (${annualRate}% annual)</p>
                            <p><strong>Restructuring Fee:</strong> ${feePercent}% of restructured amount</p>
                            <p><strong>Available Types:</strong> ${options.availableTypes.join(', ')}</p>
                            <button onclick="showRestructuringControls()">Start Restructuring Process</button>
                        </div>
                    `;
                } else {
                    optionsDiv.innerHTML = `
                        <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #ef4444; margin-top: 0;">‚ùå Restructuring Not Available</h4>
                            <p><strong>Reason:</strong> ${options.reason}</p>
                            <p><strong>Current Credit Score:</strong> ${creditScoreSystem.score}</p>
                            ${creditScoreSystem.score < 600 ? 
                                '<p style="color: #f59e0b;"><strong>Tip:</strong> Pay down debts to improve your credit score and unlock restructuring options!</p>' : 
                                ''}
                        </div>
                    `;
                }
            }
        }

        function showRestructuringControls() {
            const options = debtRestructuringSystem.getRestructuringOptions();
            const controlsDiv = document.getElementById('restructuringControls');
            const selectionDiv = document.getElementById('debtSelection');
            const typeSelect = document.getElementById('restructuringType');
            
            // Update available restructuring types
            typeSelect.innerHTML = '';
            options.availableTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                typeSelect.appendChild(option);
            });
            
            // Show eligible debts for selection
            selectionDiv.innerHTML = '';
            options.eligibleDebts.forEach(debt => {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;';
                
                const currentAnnualRate = (debt.currentRate * 12 * 100).toFixed(1);
                const newAnnualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                const monthlySavings = Math.floor(debt.balance * (debt.currentRate - options.newInterestRate));
                
                debtDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="selectedDebts" value="${debt.key}" style="margin-right: 10px;">
                        <div style="flex: 1;">
                            <strong>${debt.name}</strong><br>
                            <span>Balance: ${formatCurrency(debt.balance)}</span><br>
                            <span style="color: #ef4444;">Current Rate: ${currentAnnualRate}% annual</span> ‚Üí 
                            <span style="color: #10b981;">New Rate: ${newAnnualRate}% annual</span><br>
                            <span style="color: #10b981; font-weight: bold;">Monthly Interest Savings: ${formatCurrency(monthlySavings)}</span>
                        </div>
                    </label>
                `;
                selectionDiv.appendChild(debtDiv);
            });
            
            controlsDiv.style.display = 'block';
            document.getElementById('restructuringOptions').style.display = 'none';
        }

        function executeRestructuring() {
            const selectedCheckboxes = document.querySelectorAll('input[name="selectedDebts"]:checked');
            const selectedDebts = Array.from(selectedCheckboxes).map(cb => cb.value);
            const restructuringType = document.getElementById('restructuringType').value;
            
            if (selectedDebts.length === 0) {
                alert('Please select at least one debt to restructure');
                return;
            }
            
            const result = debtRestructuringSystem.executeRestructuring(selectedDebts, restructuringType);
            
            if (result.success) {
                let message = result.message;
                if (result.scoreChange && result.scoreChange.scoreChange !== 0) {
                    message += `\n\nCredit Score Impact:\nOld Score: ${result.scoreChange.oldScore}\nNew Score: ${result.scoreChange.newScore}\nChange: ${result.scoreChange.scoreChange > 0 ? '+' : ''}${result.scoreChange.scoreChange} points`;
                }
                alert(message);
                cancelRestructuring();
                updateDisplay();
            } else {
                alert(`Restructuring Failed: ${result.message}`);
            }
        }

        function cancelRestructuring() {
            document.getElementById('restructuringControls').style.display = 'none';
            document.getElementById('restructuringOptions').style.display = 'block';
            updateRestructuringDisplay();
        }

        // Enhanced updateDebtOptions to handle restructured debts
        const originalUpdateDebtOptions = updateDebtOptions;
        updateDebtOptions = function() {
            const debtOptions = document.getElementById('debtOptions');
            debtOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (!investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card debt-card';
                
                let creditImpactText = '';
                let cardStyle = '';
                
                if (investment.isRestructured) {
                    cardStyle = 'border: 2px solid #3b82f6; background: #eff6ff;';
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">üîÑ Restructured Debt - Improved Terms!</div>';
                } else if (key === 'payday') {
                    creditImpactText = '<div style="color: #10b981; font-weight: bold;">üí° Big credit score boost when paid off!</div>';
                } else if (key === 'creditcard') {
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">üí° Good credit score boost when paid off!</div>';
                } else {
                    creditImpactText = '<div style="color: #6b7280;">üí° Moderate credit score improvement</div>';
                }
                
                card.style.cssText = cardStyle;
                card.innerHTML = `
                    <h4>üí≥ ${investment.name}</h4>
                    <p>${investment.description}</p>
                    ${creditImpactText}
                    ${investment.isRestructured ? 
                        `<div style="font-size: 0.9em; color: #6b7280; margin: 5px 0;">
                            Original debts consolidated: 
                            ${investment.originalDebts.map(d => d.name).join(', ')}
                        </div>` : ''}
                    <div class="price-info">
                        <span class="current-price">Debt Balance: ${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to pay off" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn debt-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Pay Off
                        </button>
                    </div>
                `;
                debtOptions.appendChild(card);
            });
        };

        // Initialize the enhanced system
        if (typeof creditScoreSystem !== 'undefined') {
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
        }



        // Initialize game
        updateDisplay();
    </script>
</body>