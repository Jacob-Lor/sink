<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Portfolio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-layout">
        <div class="main-game">
            <div class="container">
                <div class="header">
                    <h1>üìà Build Your Portfolio</h1>
                    <p>Make smart investment decisions over 30 months and watch your money grow!</p>
                </div>

                <div class="game-stats">
                    <div class="stat-card">
                        <h3>üí∞ Available Cash</h3>
                        <div class="stat-value" id="cash">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìä Investment Value</h3>
                        <div class="stat-value" id="portfolioValue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>üíé Total Worth</h3>
                        <div class="stat-value" id="totalWorth">$5,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìÖ Month</h3>
                        <div class="stat-value" id="period">1 / 30</div>
                    </div>
                </div>

                <div class="news-section" id="newsSection">
                    <h3>üì∞ Market News</h3>
                    <p id="newsText">Welcome to the investment game! You start with $5,000. Make wise choices!</p>
                </div>

                <div class="debt-section" id="debtSection">
                    <h2>üí≥ Debt Options</h2>
                    <div class="debt-options" id="debtOptions">
                        <!-- Debt cards will be generated here -->
                    </div>
                </div>

                <div class="restructuring-section" id="restructuringSection">
                    <h3>üîÑ Debt Restructuring Options</h3>
                    <p>Consolidate or refinance your debts for better terms based on your credit score</p>
                    <div id="restructuringOptions"></div>
                    <div id="restructuringControls" style="display: none;">
                        <h4>Select Debts to Restructure:</h4>
                        <div id="debtSelection"></div>
                        <div style="margin-top: 15px;">
                            <label for="restructuringType">Restructuring Type:</label>
                            <select id="restructuringType">
                                <option value="consolidation">Debt Consolidation</option>
                                <option value="refinancing">Refinancing</option>
                                <option value="balance_transfer">Balance Transfer</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="execute-restructuring-btn" id="executeRestructuringBtn">Execute Restructuring</button>
                            <button class="cancel-restructuring-btn">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="investment-section" id="investmentSection" style="display: none;">
                    <h2>üíº Investment Options</h2>
                    <div class="investment-options" id="investmentOptions">
                        <!-- Investment cards will be generated here -->
                    </div>
                </div>

                <div class="portfolio-section">
                    <h2>üìã Your Portfolio</h2>
                    <div id="portfolio">
                        <p style="text-align: center; color: #666; padding: 20px;">No investments yet. Start building your portfolio!</p>
                    </div>
                </div>

                <div class="controls">
                    <button class="next-period-btn" id="nextPeriodBtn">‚è≠Ô∏è Next Month</button>
                    <button class="reset-btn" id="resetBtn">üîÑ Reset Game</button>
                </div>

                <div class="game-over" id="gameOver" style="display: none;">
                    <h2>üéâ Game Complete!</h2>
                    <div class="final-score" id="finalScore">$0</div>
                    <p>You've completed 30 months of investing!</p>
                    <button class="reset-btn" onclick="resetGame()" style="margin-top: 20px;">Play Again</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>üéØ Game Info</h3>
            
            <!-- Credit Score Section -->
            <div class="credit-score-card">
                <h4>üìä Credit Score</h4>
                <div class="credit-score-value" id="creditScore">580</div>
                <div class="credit-score-range" id="creditRange">Fair</div>
                <p id="creditDescription">Your credit is fair - keep improving!</p>
                <div class="credit-score-factors">
                    <div class="credit-score-factor">
                        <span class="credit-score-factor-label">Payment History:</span>
                        <span class="credit-score-factor-value" id="paymentHistory">0 payments</span>
                    </div>
                    <div class="credit-score-factor">
                        <span class="credit-score-factor-label">Active Debts:</span>
                        <span class="credit-score-factor-value" id="activeDebts">4 debts</span>
                    </div>
                    <div class="credit-score-factor">
                        <span class="credit-score-factor-label">Total Debts Paid:</span>
                        <span class="credit-score-factor-value" id="totalDebtsPaid">$0</span>
                    </div>
                </div>
            </div>

            <!-- Month Progress Tracker -->
            <div class="progress-tracker">
                <h4>üìÖ Month Progress</h4>
                <div class="progress-container">
                    <div class="progress-background">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-marker" id="progressMarker"></div>
                </div>
                <div class="progress-text" id="progressText">Month 1 of 30</div>
            </div>

            <!-- Strategy Tip -->
            <div class="tip-card">
                <h4>üí° Strategy Tip</h4>
                <p>Focus on paying off high-interest debts first, then diversify your investments between stocks and bonds for balanced growth.</p>
            </div>

            <!-- Add Help button to sidebar -->
            <button id="showGuidedTourBtn" style="margin:16px 0 0 0; width:100%; background:#f0f4ff; color:#2563eb; border:1px solid #2563eb; border-radius:6px; padding:8px 0; font-weight:bold; cursor:pointer;">‚ùì Show Tutorial</button>
        </div>
    </div>

    <!-- Notification Overlay -->
    <div class="notification-overlay" id="notificationOverlay">
        <div class="notification-dialog" id="notificationDialog">
            <div class="notification-icon" id="notificationIcon">üéâ</div>
            <h3 class="notification-title" id="notificationTitle">Success!</h3>
            <p class="notification-message" id="notificationMessage">Your action was successful!</p>
            <button class="notification-btn" onclick="closeNotification()">Continue</button>
        </div>
    </div>

    <div class="game-over-popup" id="gameOverPopup">
        <div class="game-over-content" id="gameOverContent">
            <div class="game-over-icon">üéâ</div>
            <h2 class="game-over-title">Congratulations!</h2>
            <p class="game-over-subtitle">You've successfully completed the game!</p>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Final Score:</span>
                    <span class="game-over-stat-value" id="finalScore"></span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Credit Score:</span>
                    <span class="game-over-stat-value" id="finalCreditScore"></span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Credit Range:</span>
                    <span class="game-over-stat-value" id="finalCreditRange"></span>
                </div>
            </div>
            <p class="game-over-message">Your journey through the investment game has come to an end. You've made smart decisions and learned a lot along the way. Keep up the good work!</p>
            <div class="game-over-buttons">
                <button class="game-over-btn primary" onclick="resetGame()">Play Again</button>
                <button class="game-over-btn secondary" onclick="closeGameOverPopup()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add guided tour overlay and tooltips -->
    <div id="guidedTourOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;"></div>
    <div id="guidedTourTooltip" style="display:none; position:absolute; z-index:10000; background:#fff; border-radius:10px; box-shadow:0 4px 24px #0002; padding:22px 20px; max-width:340px; min-width:220px; font-size:1.05em; color:#222;"></div>

    <script>
// Credit Score System Class
        class CreditScoreSystem {
            constructor() {
                this.score = 580; // Starting with fair credit
                this.paymentHistory = [];
                this.accountAge = 12; // Start with 1 year credit history
                this.consecutiveOnTimePayments = 0;
                this.totalPaymentsMade = 0;
                this.latePayments = 0;
                this.totalDebtPaidOff = 0;
                this.initialTotalDebt = 0;
                this.creditUtilization = 0;
                this.scoreHistory = [580];
                
                // Calculate initial debt for utilization tracking
                this.calculateInitialDebt();
            }

            calculateInitialDebt() {
                this.initialTotalDebt = 8500 + 1200 + 15000 + 45000; // Sum of all initial debts
            }

            // Calculate current credit utilization ratio
            calculateCreditUtilization() {
                const currentTotalDebt = this.getCurrentTotalDebt();
                const creditCardDebt = gameState.investments.creditcard.price;
                const creditCardLimit = 10000; // Assume $10k credit limit
                
                if (creditCardLimit > 0) {
                    this.creditUtilization = (creditCardDebt / creditCardLimit) * 100;
                } else {
                    this.creditUtilization = 0;
                }
                
                return this.creditUtilization;
            }

            getCurrentTotalDebt() {
                let totalDebt = 0;
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        totalDebt += investment.price;
                    }
                });
                return totalDebt;
            }

            // Process a debt payment and update credit score
            processDebtPayment(debtType, paymentAmount, debtRemaining) {
                const payment = {
                    debtType: debtType,
                    amount: paymentAmount,
                    remainingDebt: debtRemaining,
                    date: gameState.period,
                    onTime: true // Assume all payments in game are on time
                };

                this.paymentHistory.push(payment);
                this.totalPaymentsMade++;
                this.consecutiveOnTimePayments++;
                this.totalDebtPaidOff += paymentAmount;

                // Calculate score change
                const oldScore = this.score;
                this.updateCreditScore(payment);
                const scoreChange = this.score - oldScore;

                // Add to score history
                this.scoreHistory.push(this.score);

                return {
                    oldScore: oldScore,
                    newScore: this.score,
                    scoreChange: scoreChange
                };
            }

            updateCreditScore(payment) {
                let scoreChange = 0;

                // 1. Payment History (35% of score) - Most important factor
                if (payment.onTime) {
                    // Base points for making payment
                    scoreChange += Math.min(3, payment.amount / 1000); // Up to 3 points per $1000 paid
                    
                    // Bonus for consecutive payments
                    if (this.consecutiveOnTimePayments >= 6) {
                        scoreChange += 2; // Bonus for payment consistency
                    }
                    
                    // Extra bonus for paying off high-interest debt
                    if (payment.debtType === 'payday' && payment.remainingDebt === 0) {
                        scoreChange += 15; // Big boost for paying off payday loans
                    } else if (payment.debtType === 'creditcard' && payment.remainingDebt === 0) {
                        scoreChange += 12; // Good boost for paying off credit cards
                    }
                }

                // 2. Credit Utilization (30% of score)
                const utilizationChange = this.calculateUtilizationScoreChange();
                scoreChange += utilizationChange;

                // 3. Length of Credit History (15% of score)
                this.accountAge++; // Age increases each period
                if (this.accountAge % 12 === 0) { // Every year
                    scoreChange += 1;
                }

                // 4. Types of Credit (10% of score)
                const debtTypesRemaining = this.getActiveDebtTypes();
                if (debtTypesRemaining.length < 4) { // Fewer debt types is better
                    scoreChange += 1;
                }

                // 5. New Credit (10% of score) - Not applicable in this game

                // Apply diminishing returns for very high scores
                if (this.score >= 750) {
                    scoreChange *= 0.5; // Harder to improve excellent credit
                } else if (this.score >= 700) {
                    scoreChange *= 0.7; // Somewhat harder to improve good credit
                }

                // Apply the change
                this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            }

            calculateUtilizationScoreChange() {
                const currentUtilization = this.calculateCreditUtilization();
                let scoreChange = 0;

                // Credit utilization brackets with score impacts
                if (currentUtilization === 0) {
                    scoreChange += 3; // Best utilization
                } else if (currentUtilization <= 10) {
                    scoreChange += 2; // Excellent utilization
                } else if (currentUtilization <= 30) {
                    scoreChange += 1; // Good utilization
                } else if (currentUtilization <= 50) {
                    scoreChange += 0; // Fair utilization
                } else if (currentUtilization <= 75) {
                    scoreChange -= 1; // Poor utilization
                } else {
                    scoreChange -= 2; // Very poor utilization
                }

                return scoreChange;
            }

            getActiveDebtTypes() {
                const activeDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        activeDebts.push(key);
                    }
                });
                return activeDebts;
            }

            getCreditScoreRange() {
                if (this.score >= 800) return { range: "Excellent", color: "#10b981", description: "You have exceptional credit!" };
                if (this.score >= 740) return { range: "Very Good", color: "#059669", description: "You have very good credit!" };
                if (this.score >= 670) return { range: "Good", color: "#3b82f6", description: "You have good credit!" };
                if (this.score >= 580) return { range: "Fair", color: "#f59e0b", description: "Your credit is fair - keep improving!" };
                return { range: "Poor", color: "#ef4444", description: "Your credit needs work - focus on debt payments!" };
            }

            // Age credit history each period
            ageAccount() {
                this.accountAge++;
                
                // Small score boost for account aging (every 6 months)
                if (this.accountAge % 6 === 0 && this.score < 800) {
                    this.score = Math.min(850, this.score + 1);
                    this.scoreHistory.push(this.score);
                }
            }

            getScoreFactors() {
                const utilization = this.calculateCreditUtilization();
                const activeDebts = this.getActiveDebtTypes().length;
                
                return {
                    paymentHistory: `${this.consecutiveOnTimePayments} consecutive on-time payments`,
                    creditUtilization: `${utilization.toFixed(1)}% utilization`,
                    creditHistory: `${Math.floor(this.accountAge / 12)} years, ${this.accountAge % 12} months`,
                    creditMix: `${activeDebts} active debt accounts`,
                    totalPaid: `$${this.totalDebtPaidOff.toLocaleString()} total debt paid off`
                };
            }
        }

        // Initialize credit score system
        let creditScoreSystem = new CreditScoreSystem();

        // Game state (existing code with credit score integration)
        let gameState = {
            cash: 5000,
            period: 1,
            maxPeriods: 30,
            portfolio: {},
            investments: {
                stocks: { 
                    name: 'Stock Market Index', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Diversified stock market fund with moderate risk and good long-term returns',
                    volatility: 0.15 
                },
                bonds: { 
                    name: 'Government Bonds', 
                    price: 100, 
                    basePrice: 100,
                    description: 'Safe government bonds with steady, low returns',
                    volatility: 0.05 
                },
                creditcard: { 
                    name: 'Credit Card Debt', 
                    price: 8500, 
                    basePrice: 8500,
                    description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.015,
                    dueDate: 12 // Due in 12 months
                },
                payday: { 
                    name: 'Payday Loan Debt', 
                    price: 1200, 
                    basePrice: 1200,
                    description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.333,
                    dueDate: 6 // Due in 6 months
                },
                autoloan: { 
                    name: 'Auto Loan Debt', 
                    price: 15000, 
                    basePrice: 15000,
                    description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.005,
                    dueDate: 24 // Due in 24 months
                },
                mortgage: { 
                    name: 'Mortgage Debt', 
                    price: 45000, 
                    basePrice: 45000,
                    description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: 0.0033,
                    dueDate: 30 // Due in 30 months
                }
            },
            priceHistory: {},
            newsEvents: [
                "Market showing steady growth across all sectors.",
                "Economic indicators suggest continued expansion.",
                "Tech sector experiencing significant growth this month.",
                "Interest rates remain stable, benefiting bond markets.",
                "Financial advisors recommend paying off high-interest debt first.",
                "Credit card interest rates continue to climb nationwide.",
                "Auto loan rates see slight increase due to Federal Reserve policy.",
                "Mortgage rates remain competitive for qualified borrowers.",
                "Consumer debt reaches new highs - experts advise caution.",
                "Payday loan regulations tighten in several states.",
                "Real estate market shows strong fundamentals.",
                "Global markets react to positive economic data.",
                "Debt consolidation services see increased demand.",
                "Financial literacy programs emphasize debt management.",
                "Good credit scores unlock better loan terms and rates.",
                "Credit utilization below 30% is recommended by experts.",
                "Payment history is the most important factor in credit scoring.",
                "Paying off debt early can significantly boost your credit score."
            ]
        };

        // Initialize price history
        Object.keys(gameState.investments).forEach(key => {
            gameState.priceHistory[key] = [gameState.investments[key].price];
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updatePrices() {
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) {
                    // Debt grows with monthly interest
                    investment.price = Math.round(investment.price * (1 + investment.monthlyInterestRate));

                    // Overdue penalty logic
                    if (investment.dueDate && gameState.period > investment.dueDate && investment.price > 0) {
                        // 5% penalty on remaining balance
                        const penaltyAmount = Math.round(investment.price * 0.05);
                        investment.price += penaltyAmount;
                        // -5 credit score penalty
                        creditScoreSystem.score = Math.max(300, creditScoreSystem.score - 5);
                        creditScoreSystem.scoreHistory.push(creditScoreSystem.score);
                        // Notify player
                        showNotification(
                            'warning',
                            'Overdue Debt Penalty',
                            `${investment.name} is overdue!\nA 5% penalty ($${penaltyAmount.toLocaleString()}) was added and your credit score dropped by 5 points.`,
                            '‚ö†Ô∏è'
                        );
                    }
                } else {
                    // Regular investments fluctuate with market volatility
                    const change = (Math.random() - 0.5) * 2 * investment.volatility;
                    const newPrice = Math.max(investment.price * (1 + change), 10);
                    investment.price = Math.round(newPrice);
                }
                gameState.priceHistory[key].push(investment.price);
            });
        }

        function calculatePortfolioValue() {
            let totalValue = 0;
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    totalValue += gameState.portfolio[key] * gameState.investments[key].price;
                }
            });
            return totalValue;
        }

        function calculateTotalDebt() {
            let totalDebt = 0;
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    totalDebt += investment.price;
                }
            });
            return totalDebt;
        }

        function updateDisplay() {
            document.getElementById('cash').textContent = formatCurrency(gameState.cash);
            document.getElementById('period').textContent = `${gameState.period} / ${gameState.maxPeriods}`;
            
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const netWorth = gameState.cash + portfolioValue - totalDebt;
            
            document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalWorth').textContent = formatCurrency(netWorth);

            // Update progress tracker
            const progressPercentage = (gameState.period / gameState.maxPeriods) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            document.getElementById('progressMarker').style.left = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `Month ${gameState.period} of ${gameState.maxPeriods}`;

            // Update credit score display
            updateCreditScoreDisplay();

            // Show/hide investment options based on round
            const investmentSection = document.getElementById('investmentSection');
            if (gameState.period >= 5) {
                investmentSection.style.display = 'block';
                updateInvestmentOptions();
            } else {
                investmentSection.style.display = 'none';
            }

            // Update debt options
            updateDebtOptions();
            updatePortfolioDisplay();
            
            // Update restructuring options
            updateRestructuringDisplay();
        }

        function updateCreditScoreDisplay() {
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            const creditScoreElement = document.getElementById('creditScore');
            const creditRangeElement = document.getElementById('creditRange');
            const creditDescElement = document.getElementById('creditDescription');
            
            if (creditScoreElement) {
                creditScoreElement.textContent = creditScoreSystem.score;
                creditScoreElement.style.color = creditInfo.color;
            }
            
            if (creditRangeElement) {
                creditRangeElement.textContent = creditInfo.range;
                creditRangeElement.style.color = creditInfo.color;
                creditRangeElement.style.backgroundColor = `${creditInfo.color}20`; // Add opacity
            }
            
            if (creditDescElement) {
                creditDescElement.textContent = creditInfo.description;
            }

            // Update payment history
            document.getElementById('paymentHistory').textContent = 
                `${creditScoreSystem.consecutiveOnTimePayments} consecutive payments`;
            
            // Update active debts count
            const activeDebtsCount = creditScoreSystem.getActiveDebtTypes().length;
            document.getElementById('activeDebts').textContent = 
                `${activeDebtsCount} debt${activeDebtsCount !== 1 ? 's' : ''}`;
            
            // Update total debts paid
            document.getElementById('totalDebtsPaid').textContent = 
                formatCurrency(creditScoreSystem.totalDebtPaidOff);
        }

        function showCreditScoreChange(scoreChange) {
            if (scoreChange.scoreChange !== 0) {
                const changeText = scoreChange.scoreChange > 0 ? 
                    `+${scoreChange.scoreChange}` : `${scoreChange.scoreChange}`;
                
                alert(`Credit Score Updated!\nOld Score: ${scoreChange.oldScore}\nNew Score: ${scoreChange.newScore}\nChange: ${changeText} points`);
            }
        }

        function updateDebtOptions() {
            const debtOptions = document.getElementById('debtOptions');
            debtOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (!investment.isDebt || investment.price <= 0) return; // Skip if not debt or fully paid

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                let overdue = false;
                let dueDateText = '';
                if (investment.dueDate) {
                    dueDateText = `<div class="debt-due-date">Due by Month <strong>${investment.dueDate}</strong></div>`;
                    if (gameState.period > investment.dueDate) {
                        overdue = true;
                    }
                }

                const card = document.createElement('div');
                card.className = 'investment-card debt-card';
                if (overdue) {
                    card.style.border = '2px solid #ef4444';
                    card.style.background = '#fef2f2';
                }
                
                let creditImpactText = '';
                let cardStyle = '';
                
                if (investment.isRestructured) {
                    cardStyle = 'border: 2px solid #3b82f6; background: #eff6ff;';
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">üîÑ Restructured Debt - Improved Terms!</div>';
                } else if (key === 'payday') {
                    creditImpactText = '<div style="color: #10b981; font-weight: bold;">üí° Big credit score boost when paid off!</div>';
                } else if (key === 'creditcard') {
                    creditImpactText = '<div style="color: #3b82f6; font-weight: bold;">üí° Good credit score boost when paid off!</div>';
                } else {
                    creditImpactText = '<div style="color: #6b7280;">üí° Moderate credit score improvement</div>';
                }
                
                card.style.cssText += cardStyle;
                card.innerHTML = `
                    <h4>üí≥ ${investment.name}</h4>
                    <p>${investment.description}</p>
                    ${dueDateText}
                    ${overdue ? '<div style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è Overdue! Pay immediately to avoid penalties.</div>' : ''}
                    ${creditImpactText}
                    ${investment.isRestructured ? 
                        `<div style="font-size: 0.9em; color: #6b7280; margin: 5px 0;">
                            Original debts consolidated: 
                            ${investment.originalDebts.map(d => d.name).join(', ')}
                        </div>` : ''}
                    <div class="price-info">
                        <span class="current-price">Debt Balance: ${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to pay off" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn debt-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Pay Off
                        </button>
                    </div>
                `;
                debtOptions.appendChild(card);
            });

            // Show message if no debts remain
            if (debtOptions.children.length === 0) {
                debtOptions.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; color: #166534;">
                        <h3 style="margin-bottom: 12px; color: #166534;">üéâ Congratulations!</h3>
                        <p style="font-size: 1.1rem; margin-bottom: 8px;">You've successfully paid off all your debts!</p>
                        <p style="color: #059669;">Your credit score has improved significantly. You can now focus on building your investment portfolio.</p>
                    </div>
                `;
            }
        }

        function updateInvestmentOptions() {
            const investmentOptions = document.getElementById('investmentOptions');
            investmentOptions.innerHTML = '';

            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt) return;

                const priceHistory = gameState.priceHistory[key];
                const priceChange = priceHistory.length > 1 ? 
                    investment.price - priceHistory[priceHistory.length - 2] : 0;
                const priceChangePercent = priceHistory.length > 1 ? 
                    ((priceChange / priceHistory[priceHistory.length - 2]) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'investment-card';
                
                card.innerHTML = `
                    <h4>${investment.name}</h4>
                    <p>${investment.description}</p>
                    <div class="price-info">
                        <span class="current-price">${formatCurrency(investment.price)}</span>
                        <span class="price-change ${priceChange >= 0 ? 'price-up' : 'price-down'}">
                            ${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} (${priceChangePercent}%)
                        </span>
                    </div>
                    <div class="investment-controls">
                        <input type="number" class="amount-input" placeholder="Amount to invest" min="1" max="${gameState.cash}" id="amount-${key}">
                        <button class="invest-btn" onclick="makeInvestment('${key}')" ${gameState.cash <= 0 ? 'disabled' : ''}>
                            Invest
                        </button>
                    </div>
                `;
                investmentOptions.appendChild(card);
            });
        }

        function updatePortfolioDisplay() {
            const portfolioDiv = document.getElementById('portfolio');
            portfolioDiv.innerHTML = '';

            let hasInvestments = false;
            let hasDebts = false;

            // Show regular investments
            Object.keys(gameState.portfolio).forEach(key => {
                if (gameState.portfolio[key] > 0) {
                    hasInvestments = true;
                    const investment = gameState.investments[key];
                    const value = gameState.portfolio[key] * investment.price;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item';
                    item.innerHTML = `
                        <div>
                            <strong>${investment.name}</strong><br>
                            <small>${gameState.portfolio[key]} shares @ ${formatCurrency(investment.price)}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(value)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            // Show remaining debts
            Object.keys(gameState.investments).forEach(key => {
                const investment = gameState.investments[key];
                if (investment.isDebt && investment.price > 0) {
                    hasDebts = true;
                    const item = document.createElement('div');
                    item.className = 'portfolio-item debt-item';
                    item.innerHTML = `
                        <div>
                            <strong>üí≥ ${investment.name}</strong><br>
                            <small>Remaining debt balance (${(investment.monthlyInterestRate * 100).toFixed(2)}% monthly interest)</small>
                        </div>
                        <div style="text-align: right; color: #ef4444;">
                            <strong>-${formatCurrency(investment.price)}</strong>
                        </div>
                    `;
                    portfolioDiv.appendChild(item);
                }
            });

            if (!hasInvestments && !hasDebts) {
                portfolioDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No investments yet and no debts remaining. Start building your portfolio!</p>';
            } else if (!hasInvestments && hasDebts) {
                portfolioDiv.innerHTML += '<p style="text-align: center; color: #ef4444; padding: 10px; font-weight: bold;">‚ö†Ô∏è Consider paying off high-interest debt before investing!</p>';
            }
        }

        function makeInvestment(investmentKey) {
            const amountInput = document.getElementById(`amount-${investmentKey}`);
            const amount = parseInt(amountInput.value);

            if (!amount || amount <= 0) {
                showNotification('error', 'Invalid Amount', 'Please enter a valid amount to proceed.');
                return;
            }

            if (amount > gameState.cash) {
                showNotification('error', 'Insufficient Funds', `You only have ${formatCurrency(gameState.cash)} available.`);
                return;
            }

            const investment = gameState.investments[investmentKey];
            
            if (investment.isDebt) {
                // Paying off debt
                const debtPayment = Math.min(amount, investment.price);
                const oldDebtAmount = investment.price;
                investment.price -= debtPayment;
                gameState.cash -= debtPayment;
                
                // Process credit score change
                const scoreChange = creditScoreSystem.processDebtPayment(
                    investmentKey, 
                    debtPayment, 
                    investment.price
                );
                
                if (investment.price <= 0) {
                    investment.price = 0;
                    showNotification(
                        'success',
                        'Debt Paid Off! üéâ',
                        `Congratulations! You've completely paid off your ${investment.name}! Your credit score increased by ${scoreChange.scoreChange} points.`,
                        '‚úÖ'
                    );
                    createConfetti();
                } else {
                    // Partial payment
                    const remainingPercent = ((investment.price / oldDebtAmount) * 100).toFixed(1);
                    showNotification(
                        'success',
                        'Payment Successful! üí≥',
                        `You paid ${formatCurrency(debtPayment)} towards ${investment.name}. ${remainingPercent}% remaining. Credit score +${scoreChange.scoreChange} points.`,
                        'üí≥'
                    );
                }
            } else {
                // Regular investment
                const shares = Math.floor(amount / investment.price);
                const totalCost = shares * investment.price;

                if (shares === 0) {
                    showNotification('warning', 'Investment Too Small', 'The amount is too small to purchase any shares. Please increase your investment amount.');
                    return;
                }

                gameState.cash -= totalCost;
                gameState.portfolio[investmentKey] = (gameState.portfolio[investmentKey] || 0) + shares;
                
                showNotification(
                    'success',
                    'Investment Made! üìà',
                    `Successfully purchased ${shares} shares of ${investment.name} for ${formatCurrency(totalCost)}.`,
                    'üìà'
                );
            }

            amountInput.value = '';
            updateDisplay();
        }

        function nextPeriod() {
            if (gameState.period >= gameState.maxPeriods) {
                endGame();
                return;
            }

            gameState.period++;
            gameState.cash += 2000; // Add monthly income
            updatePrices();

            // Age the credit account
            creditScoreSystem.ageAccount();

            // Update news
            const randomNews = gameState.newsEvents[Math.floor(Math.random() * gameState.newsEvents.length)];
            document.getElementById('newsText').textContent = `Month ${gameState.period}: ${randomNews}`;

            // Show monthly income notification
            showNotification(
                'info',
                'Monthly Income Received! üí∞',
                `You received ${formatCurrency(2000)} in monthly income. Your new balance is ${formatCurrency(gameState.cash)}.`,
                'üí∞'
            );

            updateDisplay();

            if (gameState.period >= gameState.maxPeriods) {
                document.getElementById('nextPeriodBtn').textContent = 'üèÅ Finish Game';
                showNotification(
                    'warning',
                    'Final Month! üèÅ',
                    'This is your final month! Make your last investment decisions carefully.',
                    'üèÅ'
                );
            }
        }

        function endGame() {
            const portfolioValue = calculatePortfolioValue();
            const totalDebt = calculateTotalDebt();
            const finalWorth = gameState.cash + portfolioValue - totalDebt;
            
            // Determine if player got out of debt
            const isDebtFree = totalDebt <= 0;
            const isSuccessful = finalWorth > 0;
            
            // Update popup content based on results
            const popup = document.getElementById('gameOverPopup');
            const content = document.getElementById('gameOverContent');
            const icon = content.querySelector('.game-over-icon');
            const title = content.querySelector('.game-over-title');
            const subtitle = content.querySelector('.game-over-subtitle');
            const message = content.querySelector('.game-over-message');
            
            // Set icon and styling based on success
            if (isDebtFree && isSuccessful) {
                icon.textContent = 'üéâ';
                title.textContent = 'Congratulations!';
                subtitle.textContent = 'You\'re completely debt-free and financially successful!';
                content.className = 'game-over-content success';
                message.innerHTML = `
                    <strong>Outstanding achievement!</strong> You've not only eliminated all your debt 
                    but also built a positive net worth. Your financial discipline and smart decision-making 
                    have paid off. You're now in an excellent financial position!
                `;
                createConfetti();
            } else if (isDebtFree) {
                icon.textContent = '‚úÖ';
                title.textContent = 'Great Job!';
                subtitle.textContent = 'You\'ve successfully eliminated all your debt!';
                content.className = 'game-over-content success';
                message.innerHTML = `
                    <strong>Excellent work!</strong> You've successfully paid off all your debts. 
                    While your net worth may be negative due to investment losses, being debt-free 
                    is a major financial milestone. You're now in a much stronger financial position!
                `;
                createConfetti();
            } else if (isSuccessful) {
                icon.textContent = 'üìà';
                title.textContent = 'Good Progress!';
                subtitle.textContent = 'You\'ve built positive net worth despite remaining debt.';
                content.className = 'game-over-content';
                message.innerHTML = `
                    <strong>Solid performance!</strong> You've managed to build a positive net worth 
                    even with some remaining debt. Your investment strategy has been effective. 
                    Consider focusing more on debt elimination in future games for even better results.
                `;
            } else {
                icon.textContent = 'üìâ';
                title.textContent = 'Game Over';
                subtitle.textContent = 'You still have debt and negative net worth.';
                content.className = 'game-over-content failure';
                message.innerHTML = `
                    <strong>Room for improvement!</strong> You still have outstanding debt and negative net worth. 
                    Consider prioritizing high-interest debt payments and being more conservative with investments 
                    in your next game. Remember: debt elimination is often the best investment!
                `;
            }
            
            // Update stats
            document.getElementById('finalScore').textContent = formatCurrency(finalWorth);
            document.getElementById('finalCreditScore').textContent = creditScoreSystem.score;
            
            const creditInfo = creditScoreSystem.getCreditScoreRange();
            document.getElementById('finalCreditRange').textContent = creditInfo.range;
            document.getElementById('finalCreditRange').style.color = creditInfo.color;
            
            // Show the animated popup
            popup.classList.add('show');
            
            // Hide game sections
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'none';
            document.getElementById('nextPeriodBtn').style.display = 'none';
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }

        function closeGameOverPopup() {
            document.getElementById('gameOverPopup').classList.remove('show');
        }

        function resetGame() {
            // Reset credit score system
            creditScoreSystem = new CreditScoreSystem();
            
            gameState = {
                cash: 5000,
                period: 1,
                maxPeriods: 30,
                portfolio: {},
                investments: {
                    stocks: { 
                        name: 'Stock Market Index', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Diversified stock market fund with moderate risk and good long-term returns',
                        volatility: 0.15 
                    },
                    bonds: { 
                        name: 'Government Bonds', 
                        price: 100, 
                        basePrice: 100,
                        description: 'Safe government bonds with steady, low returns',
                        volatility: 0.05 
                    },
                    creditcard: { 
                        name: 'Credit Card Debt', 
                        price: 8500, 
                        basePrice: 8500,
                        description: 'Pay off high-interest credit card debt (1.5% monthly interest) - guaranteed return!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.015,
                        dueDate: 12 // Due in 12 months
                    },
                    payday: { 
                        name: 'Payday Loan Debt', 
                        price: 1200, 
                        basePrice: 1200,
                        description: 'Pay off extremely high-interest payday loans (33.3% monthly interest) - urgent priority!',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.333,
                        dueDate: 6 // Due in 6 months
                    },
                    autoloan: { 
                        name: 'Auto Loan Debt', 
                        price: 15000, 
                        basePrice: 15000,
                        description: 'Pay off car loan debt (0.5% monthly interest) - moderate interest rate',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.005,
                        dueDate: 24 // Due in 24 months
                    },
                    mortgage: { 
                        name: 'Mortgage Debt', 
                        price: 45000, 
                        basePrice: 45000,
                        description: 'Pay extra on mortgage (0.33% monthly interest) - low interest, but guaranteed return',
                        volatility: 0.0,
                        isDebt: true,
                        monthlyInterestRate: 0.0033,
                        dueDate: 30 // Due in 30 months
                    }
                },
                priceHistory: {},
                newsEvents: [
                    "Market showing steady growth across all sectors.",
                    "Economic indicators suggest continued expansion.",
                    "Tech sector experiencing significant growth this month.",
                    "Interest rates remain stable, benefiting bond markets.",
                    "Financial advisors recommend paying off high-interest debt first.",
                    "Credit card interest rates continue to climb nationwide.",
                    "Auto loan rates see slight increase due to Federal Reserve policy.",
                    "Mortgage rates remain competitive for qualified borrowers.",
                    "Consumer debt reaches new highs - experts advise caution.",
                    "Payday loan regulations tighten in several states.",
                    "Real estate market shows strong fundamentals.",
                    "Global markets react to positive economic data.",
                    "Debt consolidation services see increased demand.",
                    "Financial literacy programs emphasize debt management.",
                    "Good credit scores unlock better loan terms and rates.",
                    "Credit utilization below 30% is recommended by experts.",
                    "Payment history is the most important factor in credit scoring.",
                    "Paying off debt early can significantly boost your credit score."
                ]
            };

            // Reinitialize price history
            Object.keys(gameState.investments).forEach(key => {
                gameState.priceHistory[key] = [gameState.investments[key].price];
            });

            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameOverPopup').classList.remove('show');
            document.getElementById('investmentSection').style.display = 'none';
            document.getElementById('debtSection').style.display = 'block';
            document.getElementById('nextPeriodBtn').style.display = 'inline-block';
            document.getElementById('nextPeriodBtn').textContent = '‚è≠Ô∏è Next Month';
            document.getElementById('newsText').textContent = 'Welcome to the investment game! You start with $5,000 and a 580 credit score. Make wise choices!';

            updateDisplay();
        }

        // Debt Restructuring System
        class DebtRestructuringSystem {
            constructor(creditScoreSystem) {
                this.creditScoreSystem = creditScoreSystem;
                this.restructuringHistory = [];
                this.availableRestructurings = 0;
                this.lastRestructuringPeriod = 0;
            }

            // Calculate available restructuring options based on credit score
            getRestructuringOptions() {
                const score = this.creditScoreSystem.score;
                const activeDebts = this.getEligibleDebts();
                
                if (activeDebts.length === 0) {
                    return { canRestructure: false, reason: "No eligible debts to restructure" };
                }

                // Check if enough time has passed since last restructuring
                const periodsSinceLastRestructuring = gameState.period - this.lastRestructuringPeriod;
                if (periodsSinceLastRestructuring < 6 && this.restructuringHistory.length > 0) {
                    return { 
                        canRestructure: false, 
                        reason: `Must wait ${6 - periodsSinceLastRestructuring} more months before restructuring again` 
                    };
                }

                let maxDebtAmount = 0;
                let newInterestRate = 0;
                let restructuringFee = 0;
                let availableTypes = [];

                if (score >= 750) {
                    // Excellent credit - Best terms
                    maxDebtAmount = this.getTotalEligibleDebt();
                    newInterestRate = 0.003; // 0.3% monthly (3.6% annual)
                    restructuringFee = 0.01; // 1% fee
                    availableTypes = ['consolidation', 'refinancing', 'balance_transfer'];
                } else if (score >= 700) {
                    // Good credit - Good terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.8;
                    newInterestRate = 0.005; // 0.5% monthly (6% annual)
                    restructuringFee = 0.02; // 2% fee
                    availableTypes = ['consolidation', 'refinancing'];
                } else if (score >= 650) {
                    // Fair credit - Moderate terms
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.6;
                    newInterestRate = 0.008; // 0.8% monthly (9.6% annual)
                    restructuringFee = 0.03; // 3% fee
                    availableTypes = ['consolidation'];
                } else if (score >= 600) {
                    // Poor credit - Limited options
                    maxDebtAmount = this.getTotalEligibleDebt() * 0.4;
                    newInterestRate = 0.012; // 1.2% monthly (14.4% annual)
                    restructuringFee = 0.05; // 5% fee
                    availableTypes = ['consolidation'];
                } else {
                    // Very poor credit - No restructuring available
                    return { 
                        canRestructure: false, 
                        reason: "Credit score too low for debt restructuring (minimum 600 required)" 
                    };
                }

                return {
                    canRestructure: true,
                    maxDebtAmount: Math.floor(maxDebtAmount),
                    newInterestRate: newInterestRate,
                    restructuringFee: restructuringFee,
                    availableTypes: availableTypes,
                    eligibleDebts: activeDebts
                };
            }

            // Get debts eligible for restructuring (exclude mortgage for most cases)
            getEligibleDebts() {
                const eligibleDebts = [];
                Object.keys(gameState.investments).forEach(key => {
                    const investment = gameState.investments[key];
                    if (investment.isDebt && investment.price > 0) {
                        // Mortgage requires excellent credit to restructure
                        if (key === 'mortgage' && this.creditScoreSystem.score < 750) {
                            return;
                        }
                        eligibleDebts.push({
                            key: key,
                            name: investment.name,
                            balance: investment.price,
                            currentRate: investment.monthlyInterestRate
                        });
                    }
                });
                return eligibleDebts;
            }

            getTotalEligibleDebt() {
                return this.getEligibleDebts().reduce((total, debt) => total + debt.balance, 0);
            }

            // Execute debt restructuring
            executeRestructuring(selectedDebts, restructuringType) {
                const options = this.getRestructuringOptions();
                if (!options.canRestructure) {
                    return { success: false, message: options.reason };
                }

                const totalSelectedDebt = selectedDebts.reduce((sum, debtKey) => {
                    return sum + gameState.investments[debtKey].price;
                }, 0);

                if (totalSelectedDebt > options.maxDebtAmount) {
                    return { 
                        success: false, 
                        message: `Selected debt (${formatCurrency(totalSelectedDebt)}) exceeds maximum allowed (${formatCurrency(options.maxDebtAmount)})` 
                    };
                }

                // Calculate restructuring fee
                const fee = Math.floor(totalSelectedDebt * options.restructuringFee);
                if (gameState.cash < fee) {
                    return { 
                        success: false, 
                        message: `Insufficient funds to pay restructuring fee of ${formatCurrency(fee)}` 
                    };
                }

                // Execute the restructuring
                const oldDebts = [];
                selectedDebts.forEach(debtKey => {
                    const debt = gameState.investments[debtKey];
                    oldDebts.push({
                        name: debt.name,
                        balance: debt.price,
                        rate: debt.monthlyInterestRate
                    });
                    // Clear the old debt
                    debt.price = 0;
                });

                // Create new consolidated debt
                const newDebtKey = `restructured_${gameState.period}`;
                gameState.investments[newDebtKey] = {
                    name: `Restructured Debt (${restructuringType})`,
                    price: totalSelectedDebt,
                    basePrice: totalSelectedDebt,
                    description: `Consolidated debt with improved ${(options.newInterestRate * 100).toFixed(2)}% monthly interest rate`,
                    volatility: 0.0,
                    isDebt: true,
                    monthlyInterestRate: options.newInterestRate,
                    isRestructured: true,
                    originalDebts: oldDebts
                };

                // Initialize price history for new debt
                gameState.priceHistory[newDebtKey] = [totalSelectedDebt];

                // Pay the fee
                gameState.cash -= fee;

                // Record the restructuring
                this.restructuringHistory.push({
                    period: gameState.period,
                    type: restructuringType,
                    originalDebts: oldDebts,
                    newDebt: {
                        amount: totalSelectedDebt,
                        rate: options.newInterestRate
                    },
                    fee: fee,
                    creditScore: this.creditScoreSystem.score
                });

                this.lastRestructuringPeriod = gameState.period;

                // Small credit score impact for successful restructuring
                const scoreChange = this.creditScoreSystem.processDebtRestructuring(restructuringType, totalSelectedDebt);

                return {
                    success: true,
                    message: `Successfully restructured ${formatCurrency(totalSelectedDebt)} of debt!\nNew rate: ${(options.newInterestRate * 100).toFixed(2)}% monthly\nFee paid: ${formatCurrency(fee)}`,
                    scoreChange: scoreChange,
                    newDebtKey: newDebtKey
                };
            }

            getRestructuringHistory() {
                return this.restructuringHistory;
            }
        }

        // Extend CreditScoreSystem with restructuring impact
        CreditScoreSystem.prototype.processDebtRestructuring = function(restructuringType, debtAmount) {
            let scoreChange = 0;
            
            // Restructuring has mixed impact on credit score
            // Positive: Shows proactive debt management
            // Negative: Can be seen as financial stress indicator
            
            if (this.score >= 700) {
                // Good credit - minimal impact, slightly positive for proactive management
                scoreChange = Math.min(3, Math.floor(debtAmount / 10000));
            } else if (this.score >= 600) {
                // Fair credit - neutral to slightly negative impact
                scoreChange = -Math.min(2, Math.floor(debtAmount / 15000));
            } else {
                // Poor credit - more negative impact
                scoreChange = -Math.min(5, Math.floor(debtAmount / 8000));
            }

            // Type-specific adjustments
            switch(restructuringType) {
                case 'balance_transfer':
                    scoreChange += 1; // Slightly better as it's moving to lower rate
                    break;
                case 'refinancing':
                    // Neutral - no additional impact
                    break;
                case 'consolidation':
                    scoreChange -= 1; // Slightly worse as it may indicate financial stress
                    break;
            }

            const oldScore = this.score;
            this.score = Math.max(300, Math.min(850, Math.round(this.score + scoreChange)));
            this.scoreHistory.push(this.score);

            return {
                oldScore: oldScore,
                newScore: this.score,
                scoreChange: scoreChange
            };
        };

        // Initialize debt restructuring system
        let debtRestructuringSystem;

        // Enhanced game initialization
        const originalResetGame = resetGame;
        resetGame = function() {
            originalResetGame();
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
            updateDisplay();
        };

        function updateRestructuringDisplay() {
            const restructuringOptions = document.getElementById('restructuringOptions');
            if (!restructuringOptions) return;
            
            const options = debtRestructuringSystem.getRestructuringOptions();
            
            if (options.canRestructure) {
                const annualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                const feePercent = (options.restructuringFee * 100).toFixed(1);
                
                restructuringOptions.innerHTML = `
                    <div class="info-card">
                        <h4>‚úÖ Restructuring Available</h4>
                        <p><strong>Credit Score:</strong> ${creditScoreSystem.score} (${creditScoreSystem.getCreditScoreRange().range})</p>
                        <p><strong>Maximum Debt Amount:</strong> ${formatCurrency(options.maxDebtAmount)}</p>
                        <p><strong>New Interest Rate:</strong> ${(options.newInterestRate * 100).toFixed(2)}% monthly (${annualRate}% annual)</p>
                        <p><strong>Restructuring Fee:</strong> ${feePercent}% of restructured amount</p>
                        <p><strong>Available Types:</strong> ${options.availableTypes.join(', ')}</p>
                        <button class="invest-btn" onclick="showRestructuringControls()" style="margin-top: 10px;">Start Restructuring Process</button>
                    </div>
                `;
            } else {
                restructuringOptions.innerHTML = `
                    <div class="info-card">
                        <h4>‚ùå Restructuring Not Available</h4>
                        <p><strong>Reason:</strong> ${options.reason}</p>
                        <p><strong>Current Credit Score:</strong> ${creditScoreSystem.score}</p>
                        ${creditScoreSystem.score < 600 ? 
                            '<p style="color: #f59e0b;"><strong>Tip:</strong> Pay down debts to improve your credit score and unlock restructuring options!</p>' : 
                            ''}
                    </div>
                `;
            }
        }

        function showRestructuringControls() {
            const options = debtRestructuringSystem.getRestructuringOptions();
            const controlsDiv = document.getElementById('restructuringControls');
            const selectionDiv = document.getElementById('debtSelection');
            const typeSelect = document.getElementById('restructuringType');
            
            // Update available restructuring types
            typeSelect.innerHTML = '';
            options.availableTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                typeSelect.appendChild(option);
            });
            // Add Debt Extension as a batch option if at least one eligible debt
            const extensionEligibleDebts = options.eligibleDebts.filter(d => {
                const debtObj = gameState.investments[d.key];
                if (debtObj.extensionUsed === undefined) debtObj.extensionUsed = false;
                return d.balance > 0 && debtObj.dueDate !== undefined && debtObj.dueDate < 30 && !debtObj.extensionUsed;
            });
            const hasExtensionEligible = extensionEligibleDebts.length > 0;
            if (hasExtensionEligible) {
                const extOption = document.createElement('option');
                extOption.value = 'debt_extension';
                extOption.textContent = 'Debt Extension';
                typeSelect.appendChild(extOption);
            }
            
            // Show eligible debts for selection
            selectionDiv.innerHTML = '';
            const restructuringType = typeSelect.value;
            if (restructuringType === 'debt_extension' && !hasExtensionEligible) {
                selectionDiv.innerHTML = `<div style='color:#ef4444; font-size:1em; margin:12px 0;'>No debts are eligible for extension. All debts have either reached the maximum due date or have already been extended once.</div>`;
            } else {
                options.eligibleDebts.forEach(debt => {
                    const debtObj = gameState.investments[debt.key];
                    if (debtObj.extensionUsed === undefined) debtObj.extensionUsed = false;
                    const currentAnnualRate = (debt.currentRate * 12 * 100).toFixed(1);
                    const newAnnualRate = (options.newInterestRate * 12 * 100).toFixed(1);
                    const monthlySavings = Math.floor(debt.balance * (debt.currentRate - options.newInterestRate));
                    const dueDate = debtObj.dueDate;
                    const canExtend = dueDate !== undefined && dueDate < 30 && !debtObj.extensionUsed;
                    let extraInfo = '';
                    if (restructuringType === 'debt_extension') {
                        if (debtObj.extensionUsed) {
                            extraInfo = `<span style='color:#ef4444;'>Already extended once</span>`;
                        } else {
                            extraInfo = `<span style='color:#f59e0b;'>Cost: -10 credit score</span> <span style='color:#64748b;'>(One extension per debt)</span>`;
                        }
                    } else {
                        extraInfo = `<span style='color:#10b981; font-weight: bold;'>Monthly Interest Savings: ${formatCurrency(monthlySavings)}</span>`;
                    }
                    selectionDiv.innerHTML += `
                        <div class="debt-checkbox">
                            <input type="checkbox" name="selectedDebts" value="${debt.key}" ${restructuringType === 'debt_extension' && !canExtend ? 'disabled' : ''}>
                            <div class="debt-checkbox-label">
                                <div class="debt-checkbox-name">${debt.name}</div>
                                <div class="debt-checkbox-details">
                                    Balance: ${formatCurrency(debt.balance)}<br>
                                    <span style="color: #ef4444;">Current Rate: ${currentAnnualRate}% annual</span> ‚Üí 
                                    <span style="color: #10b981;">New Rate: ${newAnnualRate}% annual</span><br>
                                    <span style="color:#64748b;">Due: Month ${dueDate !== undefined ? dueDate : 'N/A'}${canExtend ? '' : ' (Max)'}</span><br>
                                    ${extraInfo}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            controlsDiv.style.display = 'block';
            document.getElementById('restructuringOptions').style.display = 'none';
            // Update debt selection UI when dropdown changes
            typeSelect.onchange = showRestructuringControls;
        }

        function executeRestructuring() {
            const selectedCheckboxes = document.querySelectorAll('input[name="selectedDebts"]:checked');
            const selectedDebts = Array.from(selectedCheckboxes).map(cb => cb.value);
            const restructuringType = document.getElementById('restructuringType').value;
            
            if (selectedDebts.length === 0) {
                showNotification('error', 'No Debts Selected', 'Please select at least one debt to restructure.');
                return;
            }
            if (restructuringType === 'debt_extension') {
                // Batch debt extension logic
                let anyMaxed = false;
                let extendedCount = 0;
                selectedDebts.forEach(debtKey => {
                    const debt = gameState.investments[debtKey];
                    if (debt.dueDate === undefined || debt.dueDate >= 30 || debt.extensionUsed) {
                        anyMaxed = true;
                    }
                });
                if (anyMaxed) {
                    showNotification('error', 'Extension Not Allowed', 'One or more selected debts are already at the maximum due date (30) or have already been extended.');
                    return;
                }
                selectedDebts.forEach(debtKey => {
                    const debt = gameState.investments[debtKey];
                    if (debt.dueDate !== undefined && debt.dueDate < 30 && !debt.extensionUsed) {
                        debt.dueDate = Math.min(30, debt.dueDate + 6);
                        debt.extensionUsed = true;
                        extendedCount++;
                    }
                });
                // Apply credit score penalty
                const penalty = 10 * extendedCount;
                creditScoreSystem.score = Math.max(300, creditScoreSystem.score - penalty);
                creditScoreSystem.scoreHistory.push(creditScoreSystem.score);
                showNotification('warning', 'Debt Extension Complete', `Extended due date by 6 months for ${extendedCount} debt(s). Credit score -${penalty}.`, '‚è≥');
                cancelRestructuring();
                updateDisplay();
                return;
            }
            // Default: original restructuring logic
            const result = debtRestructuringSystem.executeRestructuring(selectedDebts, restructuringType);
            if (result.success) {
                let message = result.message;
                if (result.scoreChange && result.scoreChange.scoreChange !== 0) {
                    message += `\n\nCredit Score Impact:\nOld Score: ${result.scoreChange.oldScore}\nNew Score: ${result.scoreChange.newScore}\nChange: ${result.scoreChange.scoreChange > 0 ? '+' : ''}${result.scoreChange.scoreChange} points`;
                }
                showNotification(
                    'success',
                    'Restructuring Successful! üîÑ',
                    message,
                    'üîÑ'
                );
                cancelRestructuring();
                updateDisplay();
            } else {
                showNotification('error', 'Restructuring Failed', result.message);
            }
        }

        function cancelRestructuring() {
            document.getElementById('restructuringControls').style.display = 'none';
            document.getElementById('restructuringOptions').style.display = 'block';
        }

        // Enhanced Notification System
        function showNotification(type, title, message, icon = null) {
            const overlay = document.getElementById('notificationOverlay');
            const dialog = document.getElementById('notificationDialog');
            const dialogIcon = document.getElementById('notificationIcon');
            const dialogTitle = document.getElementById('notificationTitle');
            const dialogMessage = document.getElementById('notificationMessage');

            // Set icon based on type if not provided
            if (!icon) {
                switch (type) {
                    case 'success':
                        icon = 'üéâ';
                        break;
                    case 'warning':
                        icon = '‚ö†Ô∏è';
                        break;
                    case 'error':
                        icon = '‚ùå';
                        break;
                    case 'info':
                        icon = '‚ÑπÔ∏è';
                        break;
                    default:
                        icon = 'üí°';
                }
            }

            // Update dialog content
            dialogIcon.textContent = icon;
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;

            // Set dialog styling based on type
            dialog.className = `notification-dialog ${type}`;

            // Show the notification
            overlay.classList.add('show');

            // Auto-hide after 4 seconds for success/info, 6 seconds for warnings/errors
            const autoHideDelay = (type === 'success' || type === 'info') ? 4000 : 6000;
            setTimeout(() => {
                if (overlay.classList.contains('show')) {
                    closeNotification();
                }
            }, autoHideDelay);
        }

        function closeNotification() {
            document.getElementById('notificationOverlay').classList.remove('show');
        }

        // Event listeners
        document.getElementById('nextPeriodBtn').addEventListener('click', nextPeriod);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('executeRestructuringBtn').addEventListener('click', executeRestructuring);
        document.querySelector('.cancel-restructuring-btn').addEventListener('click', cancelRestructuring);

        // Initialize the enhanced system
        if (typeof creditScoreSystem !== 'undefined') {
            debtRestructuringSystem = new DebtRestructuringSystem(creditScoreSystem);
        }

        // Initialize game
        updateDisplay();

        // Add guided tour overlay and tooltips
        const guidedTourHTML = `
          <div id="guidedTourOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;"></div>
          <div id="guidedTourTooltip" style="display:none; position:absolute; z-index:10000; background:#fff; border-radius:10px; box-shadow:0 4px 24px #0002; padding:22px 20px; max-width:340px; min-width:220px; font-size:1.05em; color:#222;"></div>
        `;
        document.body.insertAdjacentHTML('beforeend', guidedTourHTML);

        // Add Help button to sidebar
        const sidebar = document.querySelector('.sidebar');
        if (sidebar && !document.getElementById('showGuidedTourBtn')) {
          const helpBtn = document.createElement('button');
          helpBtn.id = 'showGuidedTourBtn';
          helpBtn.textContent = '‚ùì Show Tutorial';
          helpBtn.style = 'margin:16px 0 0 0; width:100%; background:#f0f4ff; color:#2563eb; border:1px solid #2563eb; border-radius:6px; padding:8px 0; font-weight:bold; cursor:pointer;';
          helpBtn.onclick = startGuidedTour;
          sidebar.appendChild(helpBtn);
        }

        // Define steps for the guided tour
        const guidedTourSteps = [
          {
            selector: '.header',
            title: 'Welcome!',
            content: 'This is the main game area. Your goal is to build your portfolio, pay off debts, and grow your net worth over 30 months.'
          },
          {
            selector: '.game-stats',
            title: 'Game Stats',
            content: 'Here you can see your available cash, investment value, total worth, and the current month.'
          },
          {
            selector: '.debt-section',
            title: 'Debt Section',
            content: 'Pay off debts before their due dates to avoid penalties. Overdue debts increase in balance and lower your credit score.'
          },
          {
            selector: '.investment-section',
            title: 'Investment Section',
            content: 'After month 5, you can invest in stocks and bonds. Use your cash to buy shares and grow your portfolio.'
          },
          {
            selector: '.portfolio-section',
            title: 'Your Portfolio',
            content: 'This area shows your current investments and remaining debts.'
          },
          {
            selector: '.restructuring-section',
            title: 'Debt Restructuring',
            content: 'When eligible, you can consolidate or refinance debts for better terms.'
          },
          {
            selector: '.sidebar',
            title: 'Sidebar & Progress',
            content: 'Track your credit score, month progress, and get strategy tips here. You can also restart the game or revisit this tutorial.'
          },
          {
            selector: '.controls',
            title: 'Game Controls',
            content: 'Use these buttons to advance to the next month or reset the game.'
          },
          {
            selector: null,
            title: 'All Set!',
            content: 'You are ready to play! Remember, you can revisit this tutorial anytime by clicking the "Show Tutorial" button in the sidebar.'
          }
        ];

        let guidedTourStep = 0;
        function startGuidedTour() {
          guidedTourStep = 0;
          document.getElementById('guidedTourOverlay').style.display = 'block';
          showGuidedTourStep();
        }
        function endGuidedTour() {
          document.getElementById('guidedTourOverlay').style.display = 'none';
          document.getElementById('guidedTourTooltip').style.display = 'none';
          removeHighlight();
        }
        function showGuidedTourStep() {
          const step = guidedTourSteps[guidedTourStep];
          const tooltip = document.getElementById('guidedTourTooltip');
          removeHighlight();
          if (step.selector) {
            const el = document.querySelector(step.selector);
            if (el) {
              el.classList.add('guided-tour-highlight');
              const rect = el.getBoundingClientRect();
              tooltip.style.display = 'block';
              // Position tooltip smartly
              let top = rect.bottom + 12;
              let left = rect.left + (rect.width/2) - 160;
              if (top + 200 > window.innerHeight) top = rect.top - 220;
              if (left < 10) left = 10;
              if (left + 340 > window.innerWidth) left = window.innerWidth - 350;
              tooltip.style.top = `${top + window.scrollY}px`;
              tooltip.style.left = `${left + window.scrollX}px`;
              tooltip.style.transform = '';
            }
          } else {
            tooltip.style.display = 'block';
            tooltip.style.top = '50%';
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
          }
          tooltip.innerHTML = `
            <h2 style='margin-bottom:10px;'>${step.title}</h2>
            <div style='margin-bottom:18px;'>${step.content}</div>
            <div style='text-align:right;'>
              ${guidedTourStep > 0 ? '<button id="guidedTourPrevBtn" style="margin-right:8px;">Previous</button>' : ''}
              ${guidedTourStep < guidedTourSteps.length-1 ? '<button id="guidedTourNextBtn">Next</button>' : '<button id="guidedTourFinishBtn" style="background:#2563eb; color:#fff; border:none; border-radius:6px; padding:8px 18px; font-weight:bold;">Finish</button>'}
            </div>
          `;
          if (guidedTourStep > 0) document.getElementById('guidedTourPrevBtn').onclick = function() { guidedTourStep--; showGuidedTourStep(); };
          if (guidedTourStep < guidedTourSteps.length-1) document.getElementById('guidedTourNextBtn').onclick = function() { guidedTourStep++; showGuidedTourStep(); };
          if (guidedTourStep === guidedTourSteps.length-1) document.getElementById('guidedTourFinishBtn').onclick = endGuidedTour;
        }
        function removeHighlight() {
          document.querySelectorAll('.guided-tour-highlight').forEach(el => el.classList.remove('guided-tour-highlight'));
        }
        // Add highlight style if not present
        if (!document.getElementById('guidedTourHighlightStyle')) {
          const style = document.createElement('style');
          style.id = 'guidedTourHighlightStyle';
          style.innerHTML = `.guided-tour-highlight { outline: 3px solid #f59e0b !important; box-shadow: 0 0 0 6px #fef9c3 !important; z-index:10001 !important; position:relative; }`;
          document.head.appendChild(style);
        }
        // Attach to window for global access
        window.startGuidedTour = startGuidedTour;

        // Attach event after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
          const btn = document.getElementById('showGuidedTourBtn');
          if (btn) btn.onclick = startGuidedTour;
        });

        // Patch restructuring controls to update button label and result message
        function updateRestructuringActionButton() {
            const selectedCheckboxes = document.querySelectorAll('input[name="selectedDebts"]:checked');
            const selectedCount = selectedCheckboxes.length;
            const restructuringType = document.getElementById('restructuringType').value;
            const actionBtn = document.getElementById('executeRestructuringBtn');
            if (!actionBtn) return;
            if (restructuringType === 'consolidation' || restructuringType === 'refinancing' || restructuringType === 'balance_transfer') {
                if (selectedCount === 1) {
                    actionBtn.textContent = 'REFINANCE';
                } else if (selectedCount > 1) {
                    actionBtn.textContent = 'CONSOLIDATE';
                } else {
                    actionBtn.textContent = 'EXECUTE RESTRUCTURING';
                }
            } else {
                actionBtn.textContent = 'EXECUTE RESTRUCTURING';
            }
        }
        // Attach to checkbox and dropdown changes
        function attachRestructuringActionListeners() {
            const selectionDiv = document.getElementById('debtSelection');
            if (!selectionDiv) return;
            selectionDiv.querySelectorAll('input[name="selectedDebts"]').forEach(cb => {
                cb.onchange = updateRestructuringActionButton;
            });
            const typeSelect = document.getElementById('restructuringType');
            if (typeSelect) typeSelect.onchange = updateRestructuringActionButton;
        }
        // Patch showRestructuringControls to call attachRestructuringActionListeners at the end
        const origShowRestructuringControls = showRestructuringControls;
        showRestructuringControls = function() {
            origShowRestructuringControls.apply(this, arguments);
            setTimeout(attachRestructuringActionListeners, 0);
            setTimeout(updateRestructuringActionButton, 0);
        };
        // Patch executeRestructuring to update result message
        const origExecuteRestructuring = executeRestructuring;
        executeRestructuring = function() {
            const selectedCheckboxes = document.querySelectorAll('input[name="selectedDebts"]:checked');
            const selectedCount = selectedCheckboxes.length;
            const restructuringType = document.getElementById('restructuringType').value;
            let actionWord = 'Restructuring';
            if ((restructuringType === 'consolidation' || restructuringType === 'refinancing' || restructuringType === 'balance_transfer')) {
                if (selectedCount === 1) actionWord = 'Refinancing';
                else if (selectedCount > 1) actionWord = 'Consolidation';
            }
            window._restructuringActionWord = actionWord;
            origExecuteRestructuring.apply(this, arguments);
        };
        // Patch showNotification to use the correct action word
        const origShowNotification = showNotification;
        showNotification = function(type, title, message, icon) {
            if (window._restructuringActionWord && type === 'success' && (title.includes('Restructuring Successful') || title.includes('Restructuring Complete'))) {
                title = title.replace('Restructuring', window._restructuringActionWord);
                message = message.replace('Restructuring', window._restructuringActionWord);
            }
            origShowNotification(type, title, message, icon);
            window._restructuringActionWord = undefined;
        };
    </script>
</body>
</html>